<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Repositorio de Conocimiento - Prototipo SPA</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-gradient: radial-gradient(circle at 20% 20%, rgba(95,224,199,0.08), transparent 32%),
                  radial-gradient(circle at 80% 0%, rgba(239,132,93,0.12), transparent 36%),
                  linear-gradient(180deg, #0b172a 0%, #0f1f35 36%, #0b172a 100%);
      --bg: #0b172a;
      --panel: #0f2038;
      --card: #112846;
      --card-bg: rgba(255,255,255,0.04);
      --surface-1: rgba(255,255,255,0.06);
      --surface-2: rgba(255,255,255,0.04);
      --accent: #ef845d;
      --accent-2: #5fe0c7;
      --text: #e6edf7;
      --muted: #9cb1d1;
      --border: #1d3557;
      --success: #4ade80;
      --warning: #facc15;
    }

    body.light {
      --bg-gradient: radial-gradient(circle at 30% 20%, rgba(95,224,199,0.12), transparent 30%),
                  radial-gradient(circle at 90% 0%, rgba(239,132,93,0.18), transparent 32%),
                  linear-gradient(180deg, #f7f9fc 0%, #e7edf7 46%, #f7f9fc 100%);
      --bg: #f5f7fb;
      --panel: #eef2f9;
      --card: #ffffff;
      --card-bg: #ffffff;
      --surface-1: #eef2f9;
      --surface-2: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --border: #d4dcec;
      --success: #16a34a;
      --warning: #d97706;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg-gradient);
      color: var(--text);
      min-height: 100vh;
    }

    a { color: inherit; text-decoration: none; }

    .app-shell {
      display: grid;
      grid-template-columns: 240px 1fr;
      min-height: 100vh;
      transition: grid-template-columns 0.2s ease;
    }

    .sidebar {
      background: var(--panel);
      border-right: 1px solid var(--border);
      padding: 18px 14px;
      display: grid;
      gap: 14px;
      position: sticky;
      top: 0;
      height: 100vh;
    }

    .sidebar.collapsed { width: 68px; grid-template-columns: 1fr; }
    .sidebar.collapsed .label { display: none; }
    .sidebar.collapsed .nav-item { justify-content: center; }

    .sidebar .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 800;
      letter-spacing: 0.01em;
    }

    .brand-mark {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--accent), #f7b38f);
      color: #0b172a;
      display: grid;
      place-items: center;
      font-weight: 900;
      box-shadow: 0 12px 30px rgba(239,132,93,0.35);
    }

    .nav {
      display: grid;
      gap: 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      color: var(--muted);
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease;
      border: 1px solid transparent;
    }

    .nav-item:hover { background: var(--surface-1); color: var(--text); border-color: var(--border); }
    .nav-item.active { background: rgba(239,132,93,0.14); color: var(--text); border-color: rgba(239,132,93,0.35); }

    .topbar {
      background: var(--panel);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 5;
      padding: 12px 18px;
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: space-between;
    }

    .topbar .left, .topbar .right { display: flex; align-items: center; gap: 10px; }

    .search-box {
      background: var(--surface-1);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 280px;
    }

    .search-box input {
      background: transparent;
      border: none;
      color: var(--text);
      width: 100%;
      font-size: 14px;
      outline: none;
    }

    .btn {
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn.small { padding: 6px 10px; font-size: 12px; }

    .btn.primary { background: var(--accent); color: #0b172a; box-shadow: 0 12px 30px rgba(239,132,93,0.25); }
    .btn.ghost { background: var(--surface-1); color: var(--text); border: 1px solid var(--border); }

    .main {
      padding: 18px;
      display: grid;
      gap: 16px;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.16);
    }

    h1, h2, h3, h4 { margin: 0; }
    p { margin: 6px 0 0; color: var(--muted); }

    .grid { display: grid; gap: 12px; }
    .grid.two { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    .grid.three { grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 10px;
      background: var(--surface-1);
      color: var(--text);
      font-size: 12px;
      border: 1px solid var(--border);
    }

    .status { padding: 4px 8px; border-radius: 8px; font-weight: 700; font-size: 12px; text-transform: uppercase; }
    .status.draft { background: rgba(250,204,21,0.15); color: #facc15; }
    .status.in_review { background: rgba(94,234,212,0.15); color: #5fe0c7; }
    .status.published { background: rgba(74,222,128,0.18); color: #4ade80; }

    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { text-align: left; padding: 10px; border-bottom: 1px solid var(--border); }
    .table th { color: var(--muted); font-weight: 600; text-transform: uppercase; font-size: 12px; letter-spacing: 0.04em; }

    .doc-card { display: grid; gap: 6px; }

    .flex { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .space-between { justify-content: space-between; }

    .toast-container {
      position: fixed;
      bottom: 14px;
      right: 14px;
      display: grid;
      gap: 8px;
      z-index: 50;
    }

    .toast {
      background: rgba(17,40,70,0.95);
      border: 1px solid var(--border);
      color: #fff;
      padding: 12px 14px;
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.24);
      min-width: 220px;
    }

    .login-wrapper {
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 20px;
    }

    .login-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      width: min(420px, 90vw);
      box-shadow: 0 16px 40px rgba(0,0,0,0.22);
      display: grid;
      gap: 12px;
    }

    label { font-weight: 600; color: var(--text); font-size: 14px; }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--surface-2);
      color: var(--text);
      font-family: inherit;
    }

    textarea { min-height: 160px; }

    .badge { background: var(--surface-1); padding: 6px 10px; border-radius: 10px; font-weight: 700; }
    .small { font-size: 12px; color: var(--muted); }

    .tag { background: var(--surface-1); padding: 4px 8px; border-radius: 8px; font-size: 12px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div id="app"></div>
  <div class="toast-container" id="toasts"></div>

  <script type="module">
    const storageKey = 'kb-demo-state-v1';
    const eventLimit = 10000;
    const eventFlushThreshold = 20;
    let eventBuffer = [];
    let flushTimer = null;

    const FORMAT_GROUPS = {
      pdf: ['pdf'],
      video: ['mp4', 'webm', 'mov'],
      audio: ['mp3', 'wav', 'm4a', 'ogg'],
      image: ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'],
      word: ['doc', 'docx'],
      excel: ['xls', 'xlsx', 'csv'],
      ppt: ['ppt', 'pptx']
    };
    const ALL_EXTS = Object.values(FORMAT_GROUPS).flat();

    const seedUsers = [
      { id: 'u1', name: 'Ana Viewer', email: 'ana@demo.local', role: 'viewer', password: 'demo' },
      { id: 'u2', name: 'Bruno Editor', email: 'bruno@demo.local', role: 'editor', password: 'demo' },
      { id: 'u3', name: 'Camila Admin', email: 'camila@demo.local', role: 'admin', password: 'demo' }
    ];

    const spaces = ['TI', 'Operaciones', 'Comercial', 'Talento'];
    const tagsPool = ['SOP', 'FAQ', 'Postmortem', 'Playbook', 'Onboarding', 'Incidente', 'Ventas'];
    const templates = {
      sop: {
        title: 'SOP: Proceso est√°ndar',
        content: 'Objetivo\nAlcance\nPre-requisitos\nPasos\nRoles y RACI\nValidaci√≥n y evidencia'
      },
      faq: {
        title: 'FAQ: Pregunta frecuente',
        content: 'Pregunta\nRespuesta breve\nDetalles adicionales\nEnlaces relacionados'
      },
      lesson: {
        title: 'Lecci√≥n aprendida',
        content: 'Situaci√≥n\nCausa ra√≠z\nImpacto\nAcciones correctivas\nRecomendaciones futuras'
      }
    };

    function normalizeExt(ext = '') {
      return (ext || '').toLowerCase().replace(/^\./, '');
    }

    const DATA_VERSION = '2024-review-cycle-refresh';

    const TAXONOMY_CANONICAL = ['sop','procedimiento','faq','postmortem','playbook','educacion','digital','liderazgo','audio','video','excel','ppt','induccion','referencia','investigacion'];
    const TAXONOMY_NORMALIZATION = {
      'sops': 'sop',
      's.o.p': 'sop',
      'procedimientos': 'procedimiento',
      'procedimiento': 'procedimiento',
      'procedures': 'procedimiento',
      'faqs': 'faq',
      'preguntas': 'faq',
      'post mortem': 'postmortem',
      'post-mortem': 'postmortem',
      'ppt': 'ppt',
      'pptx': 'ppt',
      'excel': 'excel',
      'xls': 'excel',
      'xlsx': 'excel'
    };

    function normalizeTags(rawTags = []) {
      const normalized = rawTags.map(t => {
        const key = t.trim().toLowerCase();
        if (TAXONOMY_NORMALIZATION[key]) return TAXONOMY_NORMALIZATION[key];
        if (TAXONOMY_CANONICAL.includes(key)) return key;
        return key;
      }).filter(Boolean);
      return Array.from(new Set(normalized));
    }

    function mimeFromExt(ext = '') {
      const map = {
        pdf: 'application/pdf',
        mp4: 'video/mp4',
        webm: 'video/webm',
        mov: 'video/quicktime',
        mp3: 'audio/mpeg',
        wav: 'audio/wav',
        m4a: 'audio/mp4',
        ogg: 'audio/ogg',
        jpg: 'image/jpeg',
        jpeg: 'image/jpeg',
        png: 'image/png',
        gif: 'image/gif',
        webp: 'image/webp',
        svg: 'image/svg+xml',
        doc: 'application/msword',
        docx: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        xls: 'application/vnd.ms-excel',
        xlsx: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        csv: 'text/csv',
        ppt: 'application/vnd.ms-powerpoint',
        pptx: 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
        html: 'text/html'
      };
      return map[normalizeExt(ext)] || 'application/octet-stream';
    }

    function extFromUrl(url = '') {
      try {
        const clean = url.split('?')[0];
        const parts = clean.split('.');
        return normalizeExt(parts[parts.length - 1] || '');
      } catch (e) {
        return '';
      }
    }

    function computeReviewFields(doc) {
      const fallbackReviewed = doc.lastReviewedAt || doc.updatedAt || Date.now();
      const reviewEveryDays = doc.reviewEveryDays || 45;
      const nextReviewAt = doc.nextReviewAt || (fallbackReviewed + reviewEveryDays * 86400000);
      const freshness = (() => {
        const now = Date.now();
        if (nextReviewAt < now) return 'vencido';
        if (nextReviewAt < now + 7 * 86400000) return 'por vencer';
        return 'al d√≠a';
      })();
      return {
        ...doc,
        owner: doc.owner || 'Sin owner',
        ownerId: doc.ownerId || '',
        tags: normalizeTags(doc.tags || []),
        classification: doc.classification || 'interno',
        retentionDays: doc.retentionDays || 365,
        audience: doc.audience || ['viewer','editor','admin','manager'],
        lastReviewedAt: fallbackReviewed,
        reviewEveryDays,
        nextReviewAt,
        freshness
      };
    }

    const baseDocs = [
      {
        id: 'd1',
        title: 'Delors - Los cuatro pilares',
        type: 'wiki',
        space: 'Talento',
        owner: seedUsers[2].name,
        ownerId: seedUsers[2].id,
        classification: 'interno',
        retentionDays: 365,
        audience: ['editor','admin','manager','viewer'],
        reviewEveryDays: 90,
        lastReviewedAt: Date.now() - 25 * 86400000,
        status: 'published',
        updatedAt: Date.now() - 1 * 86400000,
        tags: ['educacion', 'referencia'],
        content: 'Lectura clave sobre los pilares fundamentales de la educaci√≥n, disponible en PDF para consulta directa.',
        views: 84,
        version: 1,
        attachments: [{ title: 'PDF principal', url: 'https://academicrepository.s3.us-east-1.amazonaws.com/CPP-DC-Delors-Los-cuatro-pilares.pdf', ext: 'pdf', mime: mimeFromExt('pdf'), sourceType: 'url' }],
        ext: 'pdf',
        mime: mimeFromExt('pdf'),
        sourceType: 'url',
        url: 'https://academicrepository.s3.us-east-1.amazonaws.com/CPP-DC-Delors-Los-cuatro-pilares.pdf'
      },
      {
        id: 'd2',
        title: 'Experiencias de aprendizaje significativas en Colombia',
        type: 'wiki',
        space: 'Operaciones',
        owner: seedUsers[1].name,
        ownerId: seedUsers[1].id,
        classification: 'interno',
        retentionDays: 365,
        audience: ['editor','admin','manager'],
        reviewEveryDays: 60,
        lastReviewedAt: Date.now() - 30 * 86400000,
        status: 'published',
        updatedAt: Date.now() - 2 * 86400000,
        tags: ['investigacion', 'colombia'],
        content: 'Documento de referencia sobre experiencias de aprendizaje en educaci√≥n b√°sica y media.',
        views: 73,
        version: 1,
        attachments: [{ title: 'PDF de estudio', url: 'https://academicrepository.s3.us-east-1.amazonaws.com/Experiencias+de+aprendizaje+significativas+en+la+educaci%C3%B3n+b%C3%A1sica+y+media+en+Colombia.+Una+aproximaci%C3%B3n+desde+sus+actores+y+el+estado+del+arte..pdf', ext: 'pdf', mime: mimeFromExt('pdf'), sourceType: 'url' }],
        ext: 'pdf',
        mime: mimeFromExt('pdf'),
        sourceType: 'url',
        url: 'https://academicrepository.s3.us-east-1.amazonaws.com/Experiencias+de+aprendizaje+significativas+en+la+educaci%C3%B3n+b%C3%A1sica+y+media+en+Colombia.+Una+aproximaci%C3%B3n+desde+sus+actores+y+el+estado+del+arte..pdf'
      },
      {
        id: 'd3',
        title: 'Introducci√≥n al conocimiento de la ciencia',
        type: 'faq',
        space: 'TI',
        owner: seedUsers[0].name,
        ownerId: seedUsers[0].id,
        classification: 'interno',
        retentionDays: 730,
        audience: ['viewer','editor','admin','manager'],
        reviewEveryDays: 120,
        lastReviewedAt: Date.now() - 50 * 86400000,
        status: 'published',
        updatedAt: Date.now() - 3 * 86400000,
        tags: ['ciencia', 'base'],
        content: 'Material de apoyo para nuevas inducciones sobre fundamentos cient√≠ficos.',
        views: 65,
        version: 1,
        attachments: [{ title: 'PDF completo', url: 'https://academicrepository.s3.us-east-1.amazonaws.com/Introducci%C3%B3n+al+conocimiento+de+la+ciencia.pdf', ext: 'pdf', mime: mimeFromExt('pdf'), sourceType: 'url' }],
        ext: 'pdf',
        mime: mimeFromExt('pdf'),
        sourceType: 'url',
        url: 'https://academicrepository.s3.us-east-1.amazonaws.com/Introducci%C3%B3n+al+conocimiento+de+la+ciencia.pdf'
      },
      {
        id: 'd4',
        title: 'Necesidad de una educaci√≥n en un mundo digital',
        type: 'postmortem',
        space: 'Comercial',
        owner: seedUsers[2].name,
        ownerId: seedUsers[2].id,
        classification: 'confidencial',
        retentionDays: 180,
        audience: ['editor','admin','manager'],
        reviewEveryDays: 45,
        lastReviewedAt: Date.now() - 20 * 86400000,
        status: 'in_review',
        updatedAt: Date.now() - 4 * 86400000,
        tags: ['digital', 'transformacion'],
        content: 'An√°lisis sobre retos y necesidades de la educaci√≥n en contextos digitales.',
        views: 54,
        version: 1,
        attachments: [{ title: 'PDF digital', url: 'https://academicrepository.s3.us-east-1.amazonaws.com/Necesidad+de+una+educaci%C3%B3n+en+un+mundo+digital.pdf', ext: 'pdf', mime: mimeFromExt('pdf'), sourceType: 'url' }],
        ext: 'pdf',
        mime: mimeFromExt('pdf'),
        sourceType: 'url',
        url: 'https://academicrepository.s3.us-east-1.amazonaws.com/Necesidad+de+una+educaci%C3%B3n+en+un+mundo+digital.pdf'
      },
      {
        id: 'd5',
        title: 'Secretos de Finlandia',
        type: 'playbook',
        space: 'Operaciones',
        owner: seedUsers[0].name,
        ownerId: seedUsers[0].id,
        classification: 'restringido',
        retentionDays: 365,
        audience: ['admin','manager'],
        reviewEveryDays: 30,
        lastReviewedAt: Date.now() - 35 * 86400000,
        status: 'published',
        updatedAt: Date.now() - 5 * 86400000,
        tags: ['benchmark', 'educacion'],
        content: 'Benchmark internacional con aprendizajes exportables a nuestros procesos.',
        views: 62,
        version: 1,
        attachments: [{ title: 'PDF Finlandia', url: 'https://academicrepository.s3.us-east-1.amazonaws.com/secretos_finlandia.pdf', ext: 'pdf', mime: mimeFromExt('pdf'), sourceType: 'url' }],
        ext: 'pdf',
        mime: mimeFromExt('pdf'),
        sourceType: 'url',
        url: 'https://academicrepository.s3.us-east-1.amazonaws.com/secretos_finlandia.pdf'
      },
      {
        id: 'd6',
        title: 'L√≠der de alto impacto - M√≥dulo 1',
        type: 'playbook',
        space: 'Talento',
        owner: seedUsers[1].name,
        ownerId: seedUsers[1].id,
        classification: 'interno',
        retentionDays: 365,
        audience: ['viewer','editor','admin','manager'],
        reviewEveryDays: 90,
        lastReviewedAt: Date.now() - 10 * 86400000,
        status: 'published',
        updatedAt: Date.now() - 6 * 86400000,
        tags: ['liderazgo', 'video'],
        content: 'Video introductorio de liderazgo de alto impacto.',
        views: 58,
        version: 1,
        attachments: [{ title: 'Video m√≥dulo 1', url: 'https://liderazgoestrategico.s3.us-east-1.amazonaws.com/Liderazgo+de+Alto+Impacto/Modulo+1-+Introduccion/1.+Lider+de+alto+impacto.mp4', ext: 'mp4', mime: mimeFromExt('mp4'), sourceType: 'url' }],
        ext: 'mp4',
        mime: mimeFromExt('mp4'),
        sourceType: 'url',
        url: 'https://liderazgoestrategico.s3.us-east-1.amazonaws.com/Liderazgo+de+Alto+Impacto/Modulo+1-+Introduccion/1.+Lider+de+alto+impacto.mp4'
      },
      {
        id: 'd7',
        title: 'Presencia ejecutiva - M√≥dulo 1',
        type: 'playbook',
        space: 'TI',
        owner: seedUsers[2].name,
        ownerId: seedUsers[2].id,
        classification: 'interno',
        retentionDays: 365,
        audience: ['viewer','editor','admin','manager'],
        reviewEveryDays: 90,
        lastReviewedAt: Date.now() - 12 * 86400000,
        status: 'published',
        updatedAt: Date.now() - 7 * 86400000,
        tags: ['liderazgo', 'comunicacion'],
        content: 'Sesi√≥n sobre presencia ejecutiva con ejemplos pr√°cticos.',
        views: 55,
        version: 1,
        attachments: [{ title: 'Video presencia ejecutiva', url: 'https://liderazgoestrategico.s3.us-east-1.amazonaws.com/Liderazgo+de+Alto+Impacto/Modulo+1-+Introduccion/2-+Presencia-ejecutiva.mp4', ext: 'mp4', mime: mimeFromExt('mp4'), sourceType: 'url' }],
        ext: 'mp4',
        mime: mimeFromExt('mp4'),
        sourceType: 'url',
        url: 'https://liderazgoestrategico.s3.us-east-1.amazonaws.com/Liderazgo+de+Alto+Impacto/Modulo+1-+Introduccion/2-+Presencia-ejecutiva.mp4'
      },
      {
        id: 'd8',
        title: 'Audio gu√≠a de inducci√≥n',
        type: 'procedimiento',
        space: 'Operaciones',
        owner: seedUsers[0].name,
        ownerId: seedUsers[0].id,
        classification: 'interno',
        retentionDays: 90,
        audience: ['viewer','editor','admin','manager'],
        reviewEveryDays: 60,
        lastReviewedAt: Date.now() - 18 * 86400000,
        status: 'published',
        updatedAt: Date.now() - 8 * 86400000,
        tags: ['audio', 'induccion'],
        content: 'Gu√≠a en formato audio para recorridos r√°pidos de onboarding.',
        views: 46,
        version: 1,
        attachments: [{ title: 'Audio de inducci√≥n', url: 'https://www.w3schools.com/html/horse.mp3', ext: 'mp3', mime: mimeFromExt('mp3'), sourceType: 'url' }],
        ext: 'mp3',
        mime: mimeFromExt('mp3'),
        sourceType: 'url',
        url: 'https://www.w3schools.com/html/horse.mp3'
      },
      {
        id: 'd9',
        title: 'Presupuesto trimestral (XLS)',
        type: 'procedimiento',
        space: 'Comercial',
        owner: seedUsers[1].name,
        ownerId: seedUsers[1].id,
        classification: 'confidencial',
        retentionDays: 180,
        audience: ['admin','manager'],
        reviewEveryDays: 30,
        lastReviewedAt: Date.now() - 15 * 86400000,
        status: 'draft',
        updatedAt: Date.now() - 9 * 86400000,
        tags: ['finanzas', 'excel'],
        content: 'Hoja de c√°lculo con presupuesto trimestral y supuestos de ventas.',
        views: 32,
        version: 1,
        attachments: [{ title: 'XLS de presupuesto', url: 'https://file-examples.com/storage/fe28416c0daac82466e0e5c5/2017/02/file_example_XLS_10.xls', ext: 'xls', mime: mimeFromExt('xls'), sourceType: 'url' }],
        ext: 'xls',
        mime: mimeFromExt('xls'),
        sourceType: 'url',
        url: 'https://file-examples.com/storage/fe28416c0daac82466e0e5c5/2017/02/file_example_XLS_10.xls'
      },
      {
        id: 'd10',
        title: 'Presentaci√≥n estrategia (PPT)',
        type: 'playbook',
        space: 'TI',
        owner: seedUsers[2].name,
        ownerId: seedUsers[2].id,
        classification: 'restringido',
        retentionDays: 365,
        audience: ['admin','manager'],
        reviewEveryDays: 45,
        lastReviewedAt: Date.now() - 22 * 86400000,
        status: 'in_review',
        updatedAt: Date.now() - 10 * 86400000,
        tags: ['estrategia', 'ppt'],
        content: 'Presentaci√≥n ejecutiva para socializar roadmap de producto.',
        views: 41,
        version: 1,
        attachments: [{ title: 'PPT estrategia', url: 'https://file-examples.com/storage/fe77ae3fb053845ed54f9b89/2017/08/file_example_PPT_500kB.ppt', ext: 'ppt', mime: mimeFromExt('ppt'), sourceType: 'url' }],
        ext: 'ppt',
        mime: mimeFromExt('ppt'),
        sourceType: 'url',
        url: 'https://file-examples.com/storage/fe77ae3fb053845ed54f9b89/2017/08/file_example_PPT_500kB.ppt'
      }
    ];

    const resourceDocs = [];

    const seedDocs = [...baseDocs, ...resourceDocs].map(computeReviewFields);

    const seedVersions = seedDocs.map(doc => ({
      id: crypto.randomUUID(),
      docId: doc.id,
      version: 1,
      snapshotAt: doc.updatedAt,
      status: doc.status,
      title: doc.title,
      content: doc.content,
      tags: doc.tags,
      type: doc.type,
      space: doc.space,
      owner: doc.owner,
      ownerId: doc.ownerId,
      classification: doc.classification,
      retentionDays: doc.retentionDays,
      audience: doc.audience,
      reviewEveryDays: doc.reviewEveryDays,
      lastReviewedAt: doc.lastReviewedAt,
      nextReviewAt: doc.nextReviewAt,
      freshness: doc.freshness,
      attachments: doc.attachments,
      ext: doc.ext,
      mime: doc.mime,
      sourceType: doc.sourceType,
      url: doc.url
    }));

    const seedState = {
      version: DATA_VERSION,
      users: seedUsers,
      docs: seedDocs,
      events: [],
      gaps: [],
      gapTasks: [],
      feedback: [],
      follows: [],
      savedSearches: [],
      versions: seedVersions,
      config: {
        iaEnabled: true,
        versioning: true,
        locale: 'es',
        theme: 'dark',
        analytics: { range: '30', space: 'all', tab: 'overview', gapSort: 'zero', healthSort: 'stale' }
      },
      currentUser: null,
      session: null,
      sidebarCollapsed: false
    };

    const state = loadState();
    applyTheme(state.config.theme, true);
    let editorAutoSave = null;
    const autoSaveMs = 8000;

    if (state.session && !state.currentUser) {
      const user = state.users.find(u => u.id === state.session.userId);
      if (user) state.currentUser = user;
    }

    function loadState() {
      const raw = localStorage.getItem(storageKey);
      if (!raw) return structuredClone(seedState);
      try {
        const parsed = JSON.parse(raw);
        const mergedConfig = { ...seedState.config, ...(parsed.config || {}) };
        mergedConfig.analytics = { ...seedState.config.analytics, ...(parsed.config?.analytics || {}) };

        if (parsed.version !== DATA_VERSION) {
          return { ...structuredClone(seedState), config: mergedConfig };
        }

        return {
          ...structuredClone(seedState),
          ...parsed,
          docs: (parsed.docs || seedDocs).map(computeReviewFields),
          events: (parsed.events || []).slice(-eventLimit),
          config: mergedConfig,
          session: parsed.session ?? null,
          savedSearches: parsed.savedSearches || [],
          gapTasks: parsed.gapTasks || [],
          feedback: parsed.feedback ?? [],
          follows: parsed.follows ?? [],
          versions: parsed.versions ?? seedVersions
        };
      } catch (e) {
        console.warn('Estado corrupto, reseteando');
        return structuredClone(seedState);
      }
    }

    function persist() {
      localStorage.setItem(storageKey, JSON.stringify(state));
    }

    function applyTheme(theme, skipPersist = false) {
      const next = theme || 'dark';
      document.body.classList.toggle('light', next === 'light');
      state.config.theme = next;
      if (!skipPersist) persist();
    }

    function resetDemo() {
      localStorage.removeItem(storageKey);
      eventBuffer = [];
      Object.assign(state, structuredClone(seedState));
      persist();
      applyTheme(state.config.theme, true);
      render();
      toast('Datos de demo restaurados');
    }

    function toast(message) {
      const container = document.getElementById('toasts');
      const node = document.createElement('div');
      node.className = 'toast';
      node.textContent = message;
      container.appendChild(node);
      setTimeout(() => node.remove(), 2600);
    }

    function track(type, payload = {}) {
      const enriched = {
        id: crypto.randomUUID(),
        type,
        at: Date.now(),
        userId: state.currentUser?.id || null,
        user: state.currentUser?.email || 'anon',
        role: state.currentUser?.role || 'anon',
        route: location.hash || '/login',
        docId: payload.docId || payload.id || null,
        ...payload
      };
      eventBuffer.push(enriched);
      if (eventBuffer.length >= eventFlushThreshold) {
        flushEvents();
      } else {
        scheduleFlush();
      }
    }

    function scheduleFlush() {
      clearTimeout(flushTimer);
      flushTimer = setTimeout(() => flushEvents(), 500);
    }

    function flushEvents() {
      if (!eventBuffer.length) return;
      state.events = [...state.events, ...eventBuffer].slice(-eventLimit);
      eventBuffer = [];
      persist();
    }

    function exportEvents() {
      flushEvents();
      const blob = new Blob([JSON.stringify(state.events, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'telemetria-events.json';
      a.click();
      URL.revokeObjectURL(url);
      toast('Eventos exportados');
    }

    function getEvents() {
      flushEvents();
      return state.events;
    }

    function logEvent(type, payload = {}) {
      track(type, payload);
    }

    function setUser(user) {
      state.currentUser = user;
      persist();
    }

    function setSession(session) {
      state.session = session;
      if (!session) state.currentUser = null;
      persist();
    }

    function requireAuth(target) {
      if ((!state.currentUser || !state.session?.token) && target !== '/login') {
        location.hash = '#/login';
        return false;
      }
      return true;
    }

    function router() {
      const hash = location.hash.slice(1) || '/login';
      const clean = hash.split('?')[0];
      const [path, param] = clean.split('/').filter(Boolean);
      const routes = {
        'login': '/login',
        'home': '/home',
        'search': '/search',
        'doc': '/doc',
        'edit': '/edit',
        'analytics': '/analytics'
      };
      const key = routes[path] || '/login';
      if (!requireAuth(key)) return { key: '/login' };
      if (key === '/analytics' && !['admin','manager'].includes(state.currentUser.role)) {
        toast('Necesitas rol admin/manager para Anal√≠tica');
        location.hash = '#/home';
        return { key: '/home' };
      }
      return { key, param };
    }

    function render() {
      const { key, param } = router();
      if (key !== '/edit' && editorAutoSave) { clearInterval(editorAutoSave); editorAutoSave = null; }
      if (key === '/login') {
        renderLogin();
        return;
      }
      const app = document.getElementById('app');
      app.innerHTML = '';
      const shell = document.createElement('div');
      shell.className = 'app-shell';
      const sidebar = renderSidebar(key);
      const content = document.createElement('div');
      content.style.display = 'flex';
      content.style.flexDirection = 'column';
      const topbar = renderTopbar();
      const main = document.createElement('div');
      main.className = 'main';
      switch (key) {
        case '/home': main.appendChild(renderHome()); break;
        case '/search': main.appendChild(renderSearch()); break;
        case '/doc': main.appendChild(renderDoc(param)); break;
        case '/edit': main.appendChild(renderEditor(param)); break;
        case '/analytics': main.appendChild(renderAnalytics()); break;
        default: main.appendChild(renderHome());
      }
      content.appendChild(topbar);
      content.appendChild(main);
      shell.appendChild(sidebar);
      shell.appendChild(content);
      app.replaceChildren(shell);
    }

    function renderSidebar(active) {
      const navItems = [
        { href: '#/home', label: 'Home' },
        { href: '#/search', label: 'B√∫squeda' },
        { href: '#/edit/new', label: 'Crear', roles: ['editor','admin'] },
        { href: '#/analytics', label: 'Anal√≠tica', roles: ['admin','manager'] },
      ];
      const aside = document.createElement('aside');
      aside.className = 'sidebar' + (state.sidebarCollapsed ? ' collapsed' : '');
      const brand = document.createElement('div');
      brand.className = 'brand';
      brand.innerHTML = `<div class="brand-mark">T</div><span class="label">Repositorio</span>`;
      const collapseBtn = document.createElement('button');
      collapseBtn.className = 'btn ghost';
      collapseBtn.style.width = '100%';
      collapseBtn.textContent = state.sidebarCollapsed ? 'Expandir' : 'Colapsar';
      collapseBtn.onclick = () => { state.sidebarCollapsed = !state.sidebarCollapsed; persist(); render(); };
      const nav = document.createElement('div');
      nav.className = 'nav';
      navItems.forEach(item => {
        if (item.roles && !item.roles.includes(state.currentUser.role)) return;
        const link = document.createElement('a');
        link.href = item.href;
        link.className = 'nav-item' + (location.hash.startsWith(item.href) ? ' active' : '');
        link.innerHTML = `<span class="label">${item.label}</span>`;
        nav.appendChild(link);
      });
      const resetBtn = document.createElement('button');
      resetBtn.className = 'btn ghost';
      resetBtn.innerHTML = '<span class="label">Reset demo</span>';
      resetBtn.onclick = resetDemo;
      const exportBtn = document.createElement('button');
      exportBtn.className = 'btn ghost';
      exportBtn.innerHTML = '<span class="label">Exportar eventos</span>';
      exportBtn.onclick = exportEvents;
      aside.append(brand, nav, collapseBtn, resetBtn, exportBtn);
      return aside;
    }

    function renderTopbar() {
      const bar = document.createElement('div');
      bar.className = 'topbar';
      const left = document.createElement('div');
      left.className = 'left';
      const quickSearch = document.createElement('div');
      quickSearch.className = 'search-box';
      quickSearch.innerHTML = '<span>üîç</span><input placeholder="Buscar..." aria-label="Buscar" />';
      const input = quickSearch.querySelector('input');
      input.onkeydown = (e) => {
        if (e.key === 'Enter') {
          const q = input.value.trim();
          if (q) {
            state.lastQuery = q;
            logEvent('search_performed', { q });
            location.hash = '#/search?q=' + encodeURIComponent(q);
          }
        }
      };
      left.appendChild(quickSearch);
      const right = document.createElement('div');
      right.className = 'right';
      const userBadge = document.createElement('div');
      userBadge.className = 'pill';
      userBadge.textContent = `${state.currentUser.name} ¬∑ ${state.currentUser.role}`;
      const themeBtn = document.createElement('button');
      themeBtn.className = 'btn ghost';
      themeBtn.textContent = state.config.theme === 'light' ? 'Modo oscuro' : 'Modo claro';
      themeBtn.onclick = () => {
        const next = state.config.theme === 'light' ? 'dark' : 'light';
        applyTheme(next);
        toast(`Modo ${next === 'light' ? 'claro' : 'oscuro'}`);
        render();
      };
      const logout = document.createElement('button');
      logout.className = 'btn ghost';
      logout.textContent = 'Salir';
      logout.onclick = () => { setSession(null); location.hash = '#/login'; };
      if (['editor','admin'].includes(state.currentUser.role)) { right.appendChild((() => { const btn = document.createElement('button'); btn.className = 'btn primary'; btn.textContent = 'Crear'; btn.onclick = () => { location.hash = '#/edit/new'; }; return btn; })()); }
      right.append(userBadge, themeBtn, logout);
      bar.append(left, right);
      return bar;
    }

    function renderLogin() {
      const app = document.getElementById('app');
      app.innerHTML = '';
      const wrapper = document.createElement('div');
      wrapper.className = 'login-wrapper';
      const card = document.createElement('div');
      card.className = 'login-card';
      card.innerHTML = `
        <div class="flex space-between" style="align-items:center;">
          <div>
            <h2>Acceder</h2>
            <p>Inicia sesi√≥n con credenciales demo o simula SSO. El acceso est√° sujeto a pol√≠ticas corporativas.</p>
          </div>
          <button class="btn ghost" id="themeLogin">${state.config.theme === 'light' ? 'Modo oscuro' : 'Modo claro'}</button>
        </div>
        <div class="grid">
          <button class="btn primary" id="ssoBtn">Ingresar con SSO</button>
          <div class="grid">
            <label for="email">Correo</label>
            <input id="email" placeholder="usuario@demo.local" />
            <label for="password">Clave</label>
            <input id="password" type="password" placeholder="demo" />
            <label for="role">Rol</label>
            <select id="role">
              <option value="viewer">viewer</option>
              <option value="editor">editor</option>
              <option value="admin">admin</option>
              <option value="manager">manager</option>
            </select>
          </div>
          <button class="btn ghost" id="loginBtn">Ingresar</button>
          <span class="small">Demo: elige un usuario para autocompletar</span>
          <div class="flex" id="demoUsers"></div>
        </div>`;
      const demoUsers = card.querySelector('#demoUsers');
      state.users.forEach(u => {
        const b = document.createElement('button');
        b.className = 'btn ghost';
        b.textContent = `${u.name} (${u.role})`;
        b.onclick = () => {
          card.querySelector('#email').value = u.email;
          card.querySelector('#password').value = 'demo';
          card.querySelector('#role').value = u.role;
        };
        demoUsers.appendChild(b);
      });
      card.querySelector('#ssoBtn').onclick = () => {
        toast('Simulando redirecci√≥n SSO...');
        setTimeout(() => toast('SSO completado (demo)'), 800);
      };
      card.querySelector('#themeLogin').onclick = () => {
        const next = state.config.theme === 'light' ? 'dark' : 'light';
        applyTheme(next);
        toast(`Modo ${next === 'light' ? 'claro' : 'oscuro'}`);
        render();
      };
      card.querySelector('#loginBtn').onclick = () => {
        const email = card.querySelector('#email').value.trim();
        const pass = card.querySelector('#password').value.trim();
        const role = card.querySelector('#role').value;
        const user = state.users.find(u => u.email === email && u.password === pass);
        if (!user) { toast('Credenciales inv√°lidas'); return; }
        if (role !== user.role) { toast('Rol no coincide con el usuario demo'); return; }
        const token = crypto.randomUUID();
        setUser(user);
        setSession({ token, userId: user.id, role: user.role, issuedAt: Date.now() });
        logEvent('login_success', { email, role });
        location.hash = '#/home';
      };
      wrapper.appendChild(card);
      app.appendChild(wrapper);
    }

    function renderHome() {
      const container = document.createElement('div');
      container.className = 'grid';
      const hero = document.createElement('div');
      hero.className = 'card';
      hero.innerHTML = `
        <div class="flex space-between"><h2>Inicio</h2><span class="badge">Rol: ${state.currentUser.role}</span></div>
        <p>Busca, consume y crea conocimiento. Feed personalizado y tareas r√°pidas.</p>
        <div class="grid two">
          <div>
            <label for="home-search">Buscar</label>
            <div class="search-box" style="margin-top:6px;">
              <span>üîç</span>
              <input id="home-search" placeholder="Buscar en todo..." />
            </div>
          </div>
          <div class="grid" style="align-content:end;">
            <div class="flex" style="gap:8px; flex-wrap:wrap;">
              <button class="btn primary" id="home-search-btn">Buscar</button>
              ${['editor','admin'].includes(state.currentUser.role) ? '<button class="btn ghost" onclick="location.hash=\'#/edit/new\'">Crear art√≠culo</button>' : ''}
              ${['admin','manager'].includes(state.currentUser.role) ? '<button class="btn ghost" onclick="location.hash=\'#/analytics\'">Ver anal√≠tica</button>' : ''}
            </div>
            <span class="small">Tip: usa filtros avanzados en la vista de b√∫squeda</span>
          </div>
        </div>`;
      const homeSearchInput = hero.querySelector('#home-search');
      hero.querySelector('#home-search-btn').onclick = () => {
        const q = homeSearchInput.value.trim();
        logEvent('search_performed', { from: 'home', q });
        location.hash = `#/search?q=${encodeURIComponent(q)}`;
      };
      const feeds = document.createElement('div');
      feeds.className = 'grid two';
      feeds.append(
        buildListCard('Recientes', recentDocs(4)),
        buildListCard('Populares', topDocsByViews(4))
      );
      const tasks = document.createElement('div');
      tasks.className = 'card';
      const pending = state.docs.filter(d => d.status === 'in_review');
      tasks.innerHTML = `<div class="flex space-between"><h3>Workflow</h3><span class="small">Draft ‚Üí Review ‚Üí Published</span></div>`;
      if (pending.length === 0) {
        tasks.innerHTML += '<p>No hay documentos en revisi√≥n.</p>';
      } else {
        const ul = document.createElement('div');
        ul.className = 'grid';
        pending.forEach(d => {
          const row = document.createElement('div');
          row.className = 'flex space-between';
          row.innerHTML = `<span>${d.title}</span><div class="status ${d.status}">${d.status}</div>`;
          ul.appendChild(row);
        });
        tasks.appendChild(ul);
      }
      const reviewCard = document.createElement('div');
      reviewCard.className = 'card';
      const ownDocs = state.docs.filter(d => d.ownerId === state.currentUser.id).map(computeReviewFields);
      const dueSoon = ownDocs.filter(d => d.nextReviewAt <= Date.now() + 7 * 86400000);
      reviewCard.innerHTML = `<div class="flex space-between"><h3>Revisiones del owner</h3><span class="small">Frescura autom√°tica</span></div>`;
      if (!dueSoon.length) {
        reviewCard.innerHTML += '<p class="small">Sin pendientes pr√≥ximos.</p>';
      } else {
        const list = document.createElement('div');
        list.className = 'grid';
        dueSoon.sort((a, b) => a.nextReviewAt - b.nextReviewAt).forEach(d => {
          const row = document.createElement('div');
          row.className = 'flex space-between';
          row.innerHTML = `<span>${d.title}</span><span class="small">Revisar antes de ${new Date(d.nextReviewAt).toLocaleDateString()} (${d.freshness})</span>`;
          list.appendChild(row);
        });
        reviewCard.appendChild(list);
      }
      container.append(hero, feeds, tasks, reviewCard);
      return container;
    }

    function buildListCard(title, docs) {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<h3>${title}</h3>`;
      docs.forEach(doc => {
        const div = document.createElement('div');
        div.className = 'doc-card';
        div.innerHTML = `
          <div class="flex space-between">
            <a href="#/doc/${doc.id}" class="pill">${doc.title}</a>
            <span class="status ${doc.status}">${doc.status}</span>
          </div>
          <div class="flex">
            <span class="small">${doc.space}</span>
            <span class="small">${new Date(doc.updatedAt).toLocaleDateString()}</span>
          </div>`;
        card.appendChild(div);
      });
      return card;
    }

    function topDocsByViews(n) {
      return [...state.docs].sort((a,b) => b.views - a.views).slice(0,n);
    }
    function recentDocs(n) {
      return [...state.docs].sort((a,b) => b.updatedAt - a.updatedAt).slice(0,n);
    }

    function parseQuery() {
      const hash = location.hash.split('?')[1] || '';
      return Object.fromEntries(new URLSearchParams(hash));
    }

    function renderSearch() {
      const params = parseQuery();
      const q = params.q || '';
      const type = params.type || 'all';
      const space = params.space || 'all';
      const tags = params.tags ? params.tags.split(',').map(t => t.trim()).filter(Boolean) : [];
      const range = params.range || 'all';
      const selectedFormats = params.format ? params.format.split(',').filter(Boolean) : [];
      const { results, facets, suggestions, semantic } = searchDocs({ q, type, space, tags, range, formats: selectedFormats });
      const attempted = q || type !== 'all' || space !== 'all' || tags.length > 0 || range !== 'all' || selectedFormats.length;
      if (attempted) {
        logEvent('search_performed', { q, filters: { type, space, tags, range, formats: selectedFormats }, results: results.length, top: results[0]?.id });
        if (results.length === 0) logEvent('search_zero_results', { q, filters: { type, space, tags, range, formats: selectedFormats } });
      }
      const container = document.createElement('div');
      container.className = 'grid';
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="flex space-between"><h2>B√∫squeda</h2><span class="small">Full-text + filtros</span></div>
        <div class="grid two">
          <div>
            <label>Consulta</label>
            <input id="q" value="${q}" placeholder="Buscar..." />
          </div>
            <div class="grid two">
              <div>
                <label>Tipo</label>
                <select id="type">
                  <option value="all">Todos</option>
                  <option value="wiki">Wiki</option>
                  <option value="faq">FAQ</option>
                  <option value="procedimiento">Procedimiento</option>
                  <option value="postmortem">Postmortem</option>
                  <option value="playbook">Playbook</option>
                </select>
              </div>
              <div>
                <label>Espacio</label>
                <select id="space">
                  <option value="all">Todos (${facets.spaceCounts.all || state.docs.length})</option>
                  ${spaces.map(s => `<option value="${s}">${s} (${facets.spaceCounts[s] || 0})</option>`).join('')}
                </select>
              </div>
            </div>
          </div>
          <div class="grid two" style="margin-top:10px;">
            <div>
              <label>Etiquetas (coma)</label>
              <input id="tags" value="${tags.join(', ')}" placeholder="SOP, FAQ" />
            </div>
            <div class="grid two" style="gap:8px;">
              <div>
                <label>Fecha de actualizaci√≥n</label>
                <select id="range">
                  <option value="all">Cualquier fecha</option>
                  <option value="7">√öltimos 7 d√≠as</option>
                  <option value="30">√öltimos 30 d√≠as</option>
                  <option value="90">√öltimos 90 d√≠as</option>
                </select>
              </div>
              <div>
                <label>Formato</label>
                <div id="formatFilters" class="grid" style="grid-template-columns: repeat(auto-fit,minmax(120px,1fr)); gap:6px;">
                  ${Object.keys(FORMAT_GROUPS).map(g => `
                    <label style="display:flex;align-items:center;gap:6px;font-weight:500;color:var(--text);">
                      <input type="checkbox" value="${g}" class="formatCheck" ${selectedFormats.includes(g) ? 'checked' : ''}/>
                      ${g.toUpperCase()} (${facets.formatCounts[g] || 0})
                    </label>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>
          <div class="flex" style="margin-top:10px;">
            <button class="btn primary" id="runSearch">Buscar</button>
            <span class="small">Resultados: ${results.length}</span>
          </div>`;
      const typeSel = card.querySelector('#type');
      typeSel.value = type;
      const spaceSel = card.querySelector('#space');
      spaceSel.value = space;
      const rangeSel = card.querySelector('#range');
      rangeSel.value = range;
      card.querySelector('#runSearch').onclick = () => {
        const nextQ = card.querySelector('#q').value.trim();
        const nextType = typeSel.value;
        const nextSpace = spaceSel.value;
        const nextTags = card.querySelector('#tags').value.split(',').map(t => t.trim()).filter(Boolean);
        const nextRange = rangeSel.value;
        const nextFormats = Array.from(card.querySelectorAll('.formatCheck:checked')).map(c => c.value);
        const previewResults = searchDocs({ q: nextQ, type: nextType, space: nextSpace, tags: nextTags, range: nextRange, formats: nextFormats });
        logEvent('search_performed', { q: nextQ, filters: { type: nextType, space: nextSpace, tags: nextTags, range: nextRange, formats: nextFormats }, results: previewResults.results.length, source: 'search_form' });
        if (previewResults.results.length === 0) logEvent('search_zero_results', { q: nextQ, filters: { type: nextType, space: nextSpace, tags: nextTags, range: nextRange, formats: nextFormats } });
        location.hash = `#/search?q=${encodeURIComponent(nextQ)}&type=${nextType}&space=${nextSpace}&tags=${encodeURIComponent(nextTags.join(','))}&range=${nextRange}&format=${nextFormats.join(',')}`;
      };
      const activeFilters = document.createElement('div');
      activeFilters.className = 'flex';
      activeFilters.style.gap = '6px';
      const chips = [];
      if (type !== 'all') chips.push({ label: `Tipo: ${type}`, action: () => location.hash = location.hash.replace(/type=[^&]*/, 'type=all') });
      if (space !== 'all') chips.push({ label: `Espacio: ${space}`, action: () => location.hash = location.hash.replace(/space=[^&]*/, 'space=all') });
      tags.forEach(t => chips.push({ label: `Tag: ${t}`, action: () => location.hash = `#/search?q=${encodeURIComponent(q)}&type=${type}&space=${space}&range=${range}` }));
      if (range !== 'all') chips.push({ label: `Rango: ${range}d`, action: () => location.hash = location.hash.replace(/range=[^&]*/, 'range=all') });
      selectedFormats.forEach(f => chips.push({ label: `Formato: ${f}`, action: () => location.hash = '#/search' }));
      if (chips.length) {
        chips.forEach(c => {
          const pill = document.createElement('span');
          pill.className = 'tag';
          pill.style.cursor = 'pointer';
          pill.textContent = c.label + ' √ó';
          pill.onclick = c.action;
          activeFilters.appendChild(pill);
        });
        const clear = document.createElement('button');
        clear.className = 'btn ghost small';
        clear.textContent = 'Limpiar todo';
        clear.onclick = () => location.hash = '#/search';
        activeFilters.appendChild(clear);
        card.appendChild(activeFilters);
      }
      const savedWrap = document.createElement('div');
      savedWrap.className = 'grid';
      savedWrap.style.marginTop = '8px';
      savedWrap.innerHTML = `<label class="small">Guardar b√∫squeda</label><div class="flex" style="gap:6px; flex-wrap:wrap;"><input id="saveName" placeholder="Nombre" /><button class="btn ghost small" id="saveSearch">Guardar</button></div>`;
      savedWrap.querySelector('#saveSearch').onclick = () => {
        const name = savedWrap.querySelector('#saveName').value.trim() || `B√∫squeda ${new Date().toLocaleString()}`;
        state.savedSearches.push({ id: crypto.randomUUID(), name, q, filters: { type, space, tags, range, formats: selectedFormats }, alert: false, createdAt: Date.now() });
        persist();
        toast('B√∫squeda guardada');
        render();
      };
      if (state.savedSearches.length) {
        const list = document.createElement('div');
        list.className = 'grid';
        list.innerHTML = '<label class="small">Saved searches / alertas</label>';
        state.savedSearches.forEach(s => {
          const row = document.createElement('div');
          row.className = 'flex space-between';
          row.innerHTML = `<span>${s.name}</span>`;
          const actions = document.createElement('div');
          actions.className = 'flex';
          const apply = document.createElement('button');
          apply.className = 'btn ghost small';
          apply.textContent = 'Aplicar';
          apply.onclick = () => {
            const f = s.filters || {};
            location.hash = `#/search?q=${encodeURIComponent(s.q||'')}&type=${f.type||'all'}&space=${f.space||'all'}&tags=${encodeURIComponent((f.tags||[]).join(','))}&range=${f.range||'all'}&format=${(f.formats||[]).join(',')}`;
          };
          const alertToggle = document.createElement('button');
          alertToggle.className = s.alert ? 'btn primary small' : 'btn ghost small';
          alertToggle.textContent = s.alert ? 'Alerta on' : 'Crear alerta';
          alertToggle.onclick = () => { s.alert = !s.alert; persist(); render(); };
          actions.append(apply, alertToggle);
          row.appendChild(actions);
          list.appendChild(row);
        });
        savedWrap.appendChild(list);
      }
      card.appendChild(savedWrap);
      const list = document.createElement('div');
      list.className = 'grid two';
      if (results.length === 0 && attempted) {
        const empty = document.createElement('div');
        empty.className = 'card';
        empty.innerHTML = `<h3>Sin resultados</h3><p class="small">No encontramos coincidencias. Reporta un gap para generar contenido.</p><div class="grid"> <label>Asignar como tarea</label><select id="gapOwner">${state.users.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}</select><input id="gapSla" type="number" min="1" value="7" placeholder="SLA d√≠as" /><button class="btn primary" id="reportGap">Reportar gap</button></div>`;
        empty.querySelector('#reportGap').onclick = () => {
          const assignedTo = empty.querySelector('#gapOwner').value;
          const sla = Number(empty.querySelector('#gapSla').value) || 7;
          const gap = addGap({ q, filters: { type, space, tags, range, formats: selectedFormats } });
          addGapTask({ gapId: gap.id, assignedTo, slaDays: sla, status: 'open' });
          toast('Gap registrado y tarea asignada');
        };
        list.appendChild(empty);
      }
      if (suggestions.length) {
        const sugCard = document.createElement('div');
        sugCard.className = 'card';
        sugCard.innerHTML = `<h4>Quiz√°s buscabas...</h4><div class="flex" style="gap:6px;">${suggestions.map(s => `<a class="tag" href="#/search?q=${encodeURIComponent(s)}">${s}</a>`).join('')}</div>`;
        list.appendChild(sugCard);
      }
      results.forEach(r => {
        const item = document.createElement('div');
        item.className = 'card doc-card';
        item.innerHTML = `
          <div class="flex space-between">
            <a href="#/doc/${r.id}"><h3>${r.highlightedTitle || r.title}</h3></a>
            <span class="status ${r.status}">${r.status}</span>
          </div>
          <p>${r.snippet || r.content.slice(0,120)}...</p>
          <div class="flex">
            <span class="tag">${r.type}</span>
            <span class="tag">${r.space}</span>
            ${r.ext ? `<span class="tag">${r.ext.toUpperCase()}</span>` : ''}
            ${r.classification ? `<span class="tag">${r.classification}</span>` : ''}
            ${r.tags.map(t => `<span class="tag">${t}</span>`).join('')}
            <span class="small">Score ${r.score?.toFixed(2) || 0}</span>
          </div>`;
        list.appendChild(item);
      });
      if (semantic && semantic.source) {
        const iaCard = document.createElement('div');
        iaCard.className = 'card';
        iaCard.innerHTML = `<h4>Respuesta IA (demo)</h4><p>${semantic.answer}</p><div class="small">Fuente: <a href="#/doc/${semantic.source.id}">${semantic.source.title}</a></div>`;
        list.prepend(iaCard);
      }
      container.append(card, list);
      return container;
    }

    function filterByFormat(docs, selectedGroups = []) {
      if (!selectedGroups.length) return docs;
      const allowed = new Set(selectedGroups.flatMap(g => FORMAT_GROUPS[g] || []));
      return docs.filter(d => allowed.has(normalizeExt(d.ext || d.attachments?.[0]?.ext || d.attachments?.[0]?.type || '')));
    }

    function searchDocs({ q = '', type = 'all', space = 'all', tags = [], range = 'all', formats = [] }) {
      const normalized = q.trim().toLowerCase();
      const terms = normalized.split(/\s+/).filter(Boolean);
      const now = Date.now();
      const rangeDays = range === 'all' ? null : Number(range);
      const baseFiltered = state.docs.filter(d => {
        const matchesType = type === 'all' || d.type === type;
        const matchesSpace = space === 'all' || d.space === space;
        const matchesTags = tags.length === 0 || tags.every(t => d.tags.map(x => x.toLowerCase()).includes(t.toLowerCase()));
        const matchesDate = !rangeDays || d.updatedAt >= now - rangeDays * 86400000;
        return matchesType && matchesSpace && matchesTags && matchesDate;
      });
      const facetSpaceCounts = baseFiltered.reduce((acc, d) => { acc[d.space] = (acc[d.space] || 0) + 1; return acc; }, {});
      facetSpaceCounts.all = baseFiltered.length;
      const facetFormatCounts = baseFiltered.reduce((acc, d) => {
        const ext = normalizeExt(d.ext || d.attachments?.[0]?.ext || d.attachments?.[0]?.type || '');
        Object.entries(FORMAT_GROUPS).forEach(([g, list]) => { if (list.includes(ext)) acc[g] = (acc[g] || 0) + 1; });
        return acc;
      }, {});
      const scored = baseFiltered.map(doc => {
        let score = 0;
        if (terms.length === 0 && !normalized) score += Math.log1p(doc.views || 0);
        terms.forEach(t => {
          if (doc.title.toLowerCase().includes(t)) score += 3;
          if (doc.tags.some(tag => tag.toLowerCase().includes(t))) score += 2;
          if (doc.content.toLowerCase().includes(t)) score += 1;
        });
        if (doc.status === 'published') score += 2; else if (doc.status === 'in_review') score += 1;
        if (doc.freshness === 'al d√≠a') score += 1; else if (doc.freshness === 'vencido') score -= 1;
        const fb = feedbackSummary(doc.id);
        score += (fb.useful - fb.notUseful) * 0.5;
        score += Math.log1p(doc.views || 0);
        const recency = 1 / (1 + ((now - doc.updatedAt) / 86400000));
        score += recency;
        const ext = normalizeExt(doc.ext || doc.attachments?.[0]?.ext || '');
        return { ...doc, score, snippet: buildSnippet(doc.content, terms), highlightedTitle: highlightText(doc.title, terms), ext };
      });
      const formatFiltered = filterByFormat(scored, formats);
      const withQueryMatch = terms.length ? formatFiltered.filter(d => d.score > 0) : formatFiltered;
      const ordered = withQueryMatch.sort((a, b) => b.score - a.score || b.updatedAt - a.updatedAt);
      const suggestions = !ordered.length && terms.length ? suggestAlternatives(terms) : [];
      const semantic = semanticAnswer(ordered, terms, normalized);
      return { results: ordered, facets: { formatCounts: facetFormatCounts, spaceCounts: facetSpaceCounts }, suggestions, semantic };
    }

    function highlightText(text, terms = []) {
      if (!terms.length) return text;
      let out = text;
      terms.forEach(t => {
        if (!t) return;
        const re = new RegExp(`(${t})`, 'ig');
        out = out.replace(re, '<mark>$1</mark>');
      });
      return out;
    }

    function buildSnippet(content, terms = []) {
      if (!content) return '';
      if (!terms.length) return content.slice(0, 140);
      const lower = content.toLowerCase();
      const idx = terms.map(t => lower.indexOf(t)).find(i => i >= 0);
      const start = idx && idx > 40 ? idx - 40 : 0;
      const snippet = content.slice(start, start + 180);
      return highlightText(snippet, terms);
    }

    function suggestAlternatives(terms) {
      const set = new Set();
      terms.forEach(t => {
        state.docs.forEach(d => {
          d.tags.forEach(tag => { if (tag.toLowerCase().includes(t)) set.add(tag); });
          if (d.title.toLowerCase().includes(t)) set.add(d.title);
        });
      });
      return Array.from(set).slice(0, 5);
    }

    function semanticAnswer(results, terms, normalized) {
      if (!normalized || !results.length) return null;
      const top = results[0];
      const snippet = buildSnippet(top.content, terms);
      return { answer: `Posible respuesta: ${snippet}`, source: { id: top.id, title: top.title } };
    }

    function addGap(payload) {
      const gap = { id: `gap-${Date.now()}`, ...payload, reporter: state.currentUser?.email || 'anon', createdAt: Date.now() };
      state.gaps.push(gap);
      logEvent('gap_reported', gap);
      persist();
      return gap;
    }

    function addGapTask({ gapId, assignedTo, slaDays = 7, status = 'open' }) {
      const task = { id: crypto.randomUUID(), gapId, assignedTo, slaDays, status, createdAt: Date.now(), dueAt: Date.now() + slaDays * 86400000 };
      state.gapTasks.push(task);
      logEvent('gap_task_created', task);
      persist();
      return task;
    }

    function createDocFromGap(gapId) {
      const gap = state.gaps.find(g => g.id === gapId);
      if (!gap) return null;
      const owner = state.users.find(u => u.id === state.currentUser?.id) || state.users[0];
      const doc = computeReviewFields({
        id: `d${Date.now()}`,
        title: `Borrador desde gap: ${gap.q || 'consulta'}`,
        type: 'wiki',
        space: gap.filters?.space && gap.filters.space !== 'all' ? gap.filters.space : spaces[0],
        owner: owner.name,
        ownerId: owner.id,
        classification: 'interno',
        retentionDays: 365,
        audience: ['viewer','editor','admin','manager'],
        reviewEveryDays: 45,
        lastReviewedAt: Date.now(),
        status: 'draft',
        updatedAt: Date.now(),
        tags: normalizeTags(gap.filters?.tags || []),
        content: `Contexto del gap: ${gap.q || ''}. Detalle: ${JSON.stringify(gap.filters || {})}`,
        version: 0,
        attachments: [],
        ext: 'html',
        mime: mimeFromExt('html'),
        sourceType: 'url',
        url: 'https://example.com'
      });
      state.docs.push(doc);
      state.versions.push({ id: crypto.randomUUID(), docId: doc.id, version: 1, snapshotAt: doc.updatedAt, status: doc.status, title: doc.title, content: doc.content });
      logEvent('doc_created', { docId: doc.id, fromGap: gapId });
      persist();
      return doc;
    }

    function isFollowing(docId, userId = state.currentUser?.id) {
      if (!userId) return false;
      return state.follows.some(f => f.docId === docId && f.userId === userId);
    }

    function toggleFollow(docId) {
      const userId = state.currentUser?.id;
      if (!userId) return;
      const idx = state.follows.findIndex(f => f.docId === docId && f.userId === userId);
      if (idx >= 0) {
        state.follows.splice(idx, 1);
        logEvent('doc_unfollowed', { docId, userId });
        toast('Se dej√≥ de seguir');
      } else {
        state.follows.push({ id: crypto.randomUUID(), docId, userId, at: Date.now() });
        logEvent('doc_followed', { docId, userId });
        toast('Siguiendo documento');
      }
      persist();
    }

    function saveFeedback(docId, value, comment) {
      const entry = {
        id: crypto.randomUUID(),
        docId,
        value,
        comment: comment?.trim() || '',
        userId: state.currentUser?.id,
        at: Date.now()
      };
      state.feedback.push(entry);
      logEvent('doc_feedback', { docId, value, hasComment: !!entry.comment });
      persist();
    }

    function feedbackSummary(docId) {
      const items = state.feedback.filter(f => f.docId === docId);
      const useful = items.filter(f => f.value === 'useful').length;
      const notUseful = items.filter(f => f.value === 'not_useful').length;
      return { useful, notUseful, total: items.length };
    }

    function renderDoc(id) {
      const docRef = state.docs.find(d => d.id === id);
      const container = document.createElement('div');
      container.className = 'grid';
      if (!docRef) {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = '<h2>Documento no encontrado</h2>';
        container.appendChild(card);
        return container;
      }
      docRef.views = (docRef.views || 0) + 1;
      logEvent('doc_viewed', { docId: docRef.id, status: docRef.status });
      persist();
      const doc = computeReviewFields(docRef);

      const assetFrom = (item, fallbackTitle) => {
        const ext = normalizeExt(item?.ext || item?.type || extFromUrl(item?.url));
        return {
          title: item?.title || fallbackTitle || doc.title,
          url: item?.url || doc.url,
          ext,
          mime: item?.mime || mimeFromExt(ext),
          sourceType: item?.sourceType || 'url'
        };
      };

      const assets = [assetFrom(doc, doc.title), ...(doc.attachments || []).map(a => assetFrom(a, a.title))].filter(a => a.url);
      const stats = feedbackSummary(doc.id);
      const followers = () => state.follows.filter(f => f.docId === doc.id).length;
      const commentsForDoc = () => state.feedback.filter(f => f.docId === doc.id && f.comment?.trim());
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="flex space-between">
          <div>
            <h2>${doc.title}</h2>
            <div class="flex">
              <span class="tag">${doc.type}</span>
              <span class="tag">${doc.space}</span>
              ${doc.ext ? `<span class="tag">${doc.ext.toUpperCase()}</span>` : ''}
              ${doc.tags.map(t => `<span class="tag">${t}</span>`).join('')}
              <span class="tag">Owner: ${doc.owner}</span>
              <span class="tag">Clasificaci√≥n: ${doc.classification || 'interno'}</span>
              <span class="tag">Retenci√≥n: ${doc.retentionDays || 365}d</span>
              <span class="tag">Frescura: ${doc.freshness || 'al d√≠a'}</span>
            </div>
          </div>
          <div class="flex">
            <div class="status ${doc.status}">${doc.status}</div>
            ${['editor','admin'].includes(state.currentUser.role) ? `<button class="btn ghost" onclick="location.hash='#/edit/${doc.id}'">Editar</button>` : ''}
          </div>
        </div>
        <div class="grid two" style="margin:10px 0;">
          <div class="card" style="padding:10px; background:var(--surface-2);">
            <div class="small">Owner</div>
            <strong>${doc.owner}</strong>
            <div class="small">Audiencia: ${(doc.audience || []).join(', ') || 'Todas'}</div>
            <div class="small">Clasificaci√≥n: ${doc.classification || 'interno'} ¬∑ Retenci√≥n: ${doc.retentionDays || 365} d√≠as</div>
          </div>
          <div class="card" style="padding:10px; background:var(--surface-2);">
            <div class="small">Revisi√≥n</div>
            <strong>Pr√≥xima: ${new Date(doc.nextReviewAt || Date.now()).toLocaleDateString()}</strong>
            <div class="small">√öltima: ${new Date(doc.lastReviewedAt || doc.updatedAt).toLocaleDateString()} ¬∑ Cada ${doc.reviewEveryDays || 45} d√≠as</div>
            <div class="small">Estado: ${doc.freshness || 'al d√≠a'}</div>
          </div>
        </div>
        <p>${doc.content}</p>
        <div class="flex">
          <button class="btn primary" id="useful">üëç √ötil</button>
          <button class="btn ghost" id="notUseful">üëé No √∫til</button>
          <button class="btn ghost" id="follow">${isFollowing(doc.id) ? 'Siguiendo' : 'Seguir'}</button>
          <button class="btn ghost" id="report">Reportar obsoleto</button>
        </div>
        <div class="grid" style="margin-top:8px;">
          <label for="comment">Comentario (opcional)</label>
          <textarea id="comment" placeholder="Agrega contexto para mejorar el art√≠culo"></textarea>
          <div class="flex" style="gap:8px;">
            <button class="btn ghost small" id="commentSend">Enviar comentarios</button>
          </div>
        </div>
        <span class="small" id="statsLine">Feedback: ${stats.useful} üëç / ${stats.notUseful} üëé ¬∑ Seguidores: ${followers()}</span>
        <span class="small">√öltima actualizaci√≥n: ${new Date(doc.updatedAt).toLocaleString()} ¬∑ Vistas: ${doc.views}</span>`;

      if (assets.length) {
        const viewer = document.createElement('div');
        viewer.className = 'card';
        viewer.style.background = 'var(--surface-2)';
        viewer.innerHTML = '<h4>Vista previa embebida</h4>';
        const previewArea = document.createElement('div');
        viewer.appendChild(previewArea);

        const renderEmbedded = (asset) => {
          previewArea.innerHTML = '';
          const ext = normalizeExt(asset.ext);
          const url = asset.url;
          const controls = document.createElement('div');
          controls.className = 'flex';
          controls.style.gap = '6px';
          controls.style.marginBottom = '6px';
          const open = document.createElement('a');
          open.className = 'btn ghost small';
          open.textContent = 'Abrir en pesta√±a';
          open.href = url;
          open.target = '_blank';
          open.rel = 'noopener';
          open.onclick = () => logEvent('doc_open_external', { docId: doc.id, ext });
          const copy = document.createElement('button');
          copy.className = 'btn ghost small';
          copy.textContent = 'Copiar enlace';
          copy.onclick = async () => {
            try { await navigator.clipboard.writeText(url); toast('Enlace copiado'); }
            catch { toast('No se pudo copiar'); }
          };
          const report = document.createElement('button');
          report.className = 'btn ghost small';
          report.textContent = 'Reportar problema';
          report.onclick = () => {
            const reason = prompt('Describe el problema (CORS, formato, bloqueo, etc.)');
            logEvent('doc_preview_reported', { docId: doc.id, ext, reason: reason || 'no_reason' });
            toast('Reporte enviado');
          };
          const download = document.createElement('a');
          download.className = 'btn primary small';
          download.textContent = 'Descargar';
          download.href = url;
          download.download = asset.title || doc.title;
          download.onclick = () => logEvent('doc_downloaded', { docId: doc.id, ext });
          controls.append(open, copy, download, report);
          previewArea.appendChild(controls);

          const skeleton = document.createElement('div');
          skeleton.className = 'skeleton';
          skeleton.style.height = '32px';
          skeleton.style.marginBottom = '8px';
          previewArea.appendChild(skeleton);

          const renderFallback = (reason) => {
            skeleton.remove();
            const fallback = document.createElement('div');
            fallback.className = 'card';
            fallback.style.background = 'var(--surface-1)';
            fallback.innerHTML = `<strong>${asset.title || 'Archivo'}</strong><div class="small">${ext.toUpperCase()} ¬∑ ${reason || 'Sin vista previa disponible'}</div>`;
            const buttons = document.createElement('div');
            buttons.className = 'flex';
            buttons.style.gap = '6px';
            const openBtn = document.createElement('a');
            openBtn.className = 'btn ghost small';
            openBtn.href = url;
            openBtn.target = '_blank';
            openBtn.rel = 'noopener';
            openBtn.textContent = 'Abrir';
            openBtn.onclick = () => logEvent('doc_open_external', { docId: doc.id, ext });
            const dlBtn = document.createElement('a');
            dlBtn.className = 'btn primary small';
            dlBtn.href = url;
            dlBtn.download = asset.title || doc.title;
            dlBtn.textContent = 'Descargar';
            dlBtn.onclick = () => logEvent('doc_downloaded', { docId: doc.id, ext });
            buttons.append(openBtn, dlBtn);
            fallback.appendChild(buttons);
            previewArea.appendChild(fallback);
            logEvent('doc_preview_rendered', { docId: doc.id, ext, mode: 'fallback' });
            logEvent('preview_fallback', { docId: doc.id, ext });
          };

          const isGroup = (group) => FORMAT_GROUPS[group]?.includes(ext);

          const removeSkeleton = () => skeleton.remove();

          const renderPdf = () => {
            const tools = document.createElement('div');
            tools.className = 'flex';
            tools.style.gap = '8px';
            tools.style.marginBottom = '6px';
            const search = document.createElement('input');
            search.placeholder = 'Buscar en PDF';
            search.className = 'input';
            search.onchange = () => { iframe.src = `${url}#search=${encodeURIComponent(search.value)}`; };
            const pageJump = document.createElement('input');
            pageJump.type = 'number';
            pageJump.min = 1;
            pageJump.placeholder = 'Ir a p√°gina';
            pageJump.onchange = () => { if (!pageJump.value) return; iframe.src = `${url}#page=${pageJump.value}`; };
            tools.append(search, pageJump);
            previewArea.appendChild(tools);
            const thumbs = document.createElement('div');
            thumbs.className = 'flex';
            thumbs.style.gap = '6px';
            thumbs.style.flexWrap = 'wrap';
            for (let i = 1; i <= 5; i++) {
              const thumb = document.createElement('button');
              thumb.className = 'btn ghost small';
              thumb.textContent = `P√°g ${i}`;
              thumb.onclick = () => { iframe.src = `${url}#page=${i}`; };
              thumbs.appendChild(thumb);
            }
            previewArea.appendChild(thumbs);
            const iframe = document.createElement('iframe');
            iframe.src = url;
            iframe.style.width = '100%';
            iframe.style.height = '70vh';
            iframe.style.border = '0';
            iframe.loading = 'lazy';
            iframe.onload = () => removeSkeleton();
            iframe.onerror = () => renderFallback('CORS o bloqueo al cargar PDF');
            previewArea.appendChild(iframe);
            logEvent('doc_preview_rendered', { docId: doc.id, ext, mode: 'embed_pdf' });
          };

          const renderVideoAudio = (isVideo) => {
            const media = document.createElement(isVideo ? 'video' : 'audio');
            media.src = url;
            media.controls = true;
            if (isVideo) {
              media.style.width = '100%';
              media.style.maxHeight = '70vh';
              media.style.borderRadius = '12px';
            } else {
              media.style.width = '100%';
            }
            const speed = document.createElement('select');
            speed.className = 'input';
            [0.75, 1, 1.25, 1.5, 2].forEach(v => {
              const opt = document.createElement('option');
              opt.value = v;
              opt.textContent = `${v}x`;
              if (v === 1) opt.selected = true;
              speed.appendChild(opt);
            });
            speed.onchange = () => media.playbackRate = Number(speed.value);

            const transcript = document.createElement('textarea');
            transcript.readOnly = true;
            transcript.className = 'input';
            transcript.style.height = '120px';
            transcript.value = asset.transcript || doc.content || 'Transcripci√≥n no disponible';
            const finder = document.createElement('input');
            finder.placeholder = 'Buscar en transcripci√≥n';
            finder.className = 'input';
            finder.oninput = () => {
              const q = finder.value.toLowerCase();
              const idx = transcript.value.toLowerCase().indexOf(q);
              if (idx >= 0) { transcript.focus(); transcript.setSelectionRange(idx, idx + q.length); }
            };

            const chapters = document.createElement('div');
            chapters.className = 'flex';
            chapters.style.gap = '6px';
            ['00:00 Intro', '02:00 Clave', '05:00 Cierre'].forEach(mark => {
              const btn = document.createElement('button');
              btn.className = 'btn ghost small';
              btn.textContent = mark;
              btn.onclick = () => { const mins = Number(mark.split(':')[0]); media.currentTime = mins * 60; media.play(); };
              chapters.appendChild(btn);
            });

            const tools = document.createElement('div');
            tools.className = 'grid';
            tools.style.gap = '6px';
            tools.appendChild(speed);
            tools.appendChild(chapters);
            tools.appendChild(finder);
            tools.appendChild(transcript);

            media.onloadstart = () => skeleton.textContent = 'Cargando recurso...';
            media.oncanplay = () => removeSkeleton();
            media.onerror = () => renderFallback('No se pudo reproducir media (CORS/bloqueado)');
            previewArea.append(media, tools);
            logEvent('doc_preview_rendered', { docId: doc.id, ext, mode: isVideo ? 'embed_video' : 'embed_audio' });
          };

          const renderImage = () => {
            const wrap = document.createElement('div');
            wrap.style.overflow = 'auto';
            wrap.style.maxHeight = '70vh';
            wrap.style.borderRadius = '12px';
            const img = document.createElement('img');
            img.src = url;
            img.alt = asset.title || doc.title;
            img.style.width = '100%';
            img.style.objectFit = 'contain';
            let zoom = 1;
            const zoomCtl = document.createElement('input');
            zoomCtl.type = 'range';
            zoomCtl.min = '0.5';
            zoomCtl.max = '2';
            zoomCtl.step = '0.1';
            zoomCtl.value = '1';
            zoomCtl.oninput = () => { zoom = Number(zoomCtl.value); img.style.transform = `scale(${zoom})`; };
            const meta = document.createElement('div');
            meta.className = 'small';
            meta.textContent = `Formato ${ext.toUpperCase()} ¬∑ ${asset.mime || 'desconocido'}`;
            img.onload = () => removeSkeleton();
            img.onerror = () => renderFallback('No se pudo cargar la imagen');
            wrap.appendChild(img);
            previewArea.append(wrap, zoomCtl, meta);
            logEvent('doc_preview_rendered', { docId: doc.id, ext, mode: 'embed_image' });
          };

          const renderOfficeLocal = async () => {
            try {
              const res = await fetch(url);
              const buf = await res.arrayBuffer();
              if (FORMAT_GROUPS.word.includes(ext) && window.mammoth) {
                const result = await window.mammoth.convertToHtml({ arrayBuffer: buf });
                const html = document.createElement('div');
                html.innerHTML = result.value;
                previewArea.appendChild(html);
                removeSkeleton();
                logEvent('doc_preview_rendered', { docId: doc.id, ext, mode: 'parsed_word' });
                return;
              }
              if (FORMAT_GROUPS.excel.includes(ext) && window.XLSX) {
                const wb = XLSX.read(buf, { type: 'array' });
                const sheet = wb.Sheets[wb.SheetNames[0]];
                const table = document.createElement('div');
                table.innerHTML = XLSX.utils.sheet_to_html(sheet);
                previewArea.appendChild(table);
                removeSkeleton();
                logEvent('doc_preview_rendered', { docId: doc.id, ext, mode: 'parsed_excel' });
                return;
              }
              renderFallback('Vista previa no soportada para archivo local');
            } catch (e) {
              renderFallback('Error al leer archivo local');
            }
          };

          if (ext === 'pdf') return renderPdf();
          if (isGroup('video')) return renderVideoAudio(true);
          if (isGroup('audio')) return renderVideoAudio(false);
          if (isGroup('image')) return renderImage();

          const isOffice = () => isGroup('word') || isGroup('excel') || isGroup('ppt');
          if (isOffice()) {
            if (url.startsWith('http')) {
              const officeUrl = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(url)}`;
              const iframe = document.createElement('iframe');
              iframe.src = officeUrl;
              iframe.style.width = '100%';
              iframe.style.height = '70vh';
              iframe.style.border = '0';
              iframe.loading = 'lazy';
              iframe.onload = () => removeSkeleton();
              iframe.onerror = () => renderFallback('CORS o bloqueo en Office viewer');
              previewArea.appendChild(iframe);
              logEvent('doc_preview_rendered', { docId: doc.id, ext, mode: 'office' });
              return;
            }
            return renderOfficeLocal();
          }

          renderFallback('Vista previa no soportada');
        };

        const list = document.createElement('div');
        list.className = 'grid';
        list.style.marginTop = '10px';
        list.innerHTML = '<div class="small">Selecciona un recurso para previsualizar</div>';
        assets.forEach(asset => {
          const row = document.createElement('div');
          row.className = 'flex space-between';
          row.style.alignItems = 'center';
          row.innerHTML = `<div class="flex" style="gap:8px;align-items:center;"><span class="tag">${(asset.ext || 'file').toUpperCase()}</span><span>${asset.title || 'Archivo'}</span></div>`;
          const btn = document.createElement('button');
          btn.className = 'btn ghost small';
          btn.textContent = 'Ver';
          btn.onclick = () => renderEmbedded(asset);
          row.appendChild(btn);
          list.appendChild(row);
        });
        viewer.append(list, previewArea);
        card.appendChild(viewer);
        renderEmbedded(assets[0]);
      }

      const commentInput = card.querySelector('#comment');
      const statsLine = card.querySelector('#statsLine');
      const followBtn = card.querySelector('#follow');
      const refreshStats = () => {
        const next = feedbackSummary(doc.id);
        statsLine.textContent = `Feedback: ${next.useful} üëç / ${next.notUseful} üëé ¬∑ Seguidores: ${followers()}`;
        followBtn.textContent = isFollowing(doc.id) ? 'Siguiendo' : 'Seguir';
        renderComments();
      };
      card.querySelector('#useful').onclick = () => {
        saveFeedback(doc.id, 'useful', commentInput.value);
        commentInput.value = '';
        toast('Feedback registrado');
        refreshStats();
      };
      card.querySelector('#notUseful').onclick = () => {
        saveFeedback(doc.id, 'not_useful', commentInput.value);
        commentInput.value = '';
        toast('Gracias por el feedback');
        refreshStats();
      };
      card.querySelector('#commentSend').onclick = () => {
        if (!commentInput.value.trim()) { toast('Agrega un comentario'); return; }
        saveFeedback(doc.id, 'comment', commentInput.value);
        commentInput.value = '';
        toast('Comentarios enviados');
        refreshStats();
      };
      followBtn.onclick = () => { toggleFollow(doc.id); refreshStats(); };
      card.querySelector('#report').onclick = () => { logEvent('doc_outdated_reported', { docId: doc.id }); toast('Reporte enviado'); };
      container.appendChild(card);

      const commentsCard = document.createElement('div');
      commentsCard.className = 'card';
      commentsCard.innerHTML = '<h3>Comentarios p√∫blicos</h3>';
      const commentsList = document.createElement('div');
      commentsCard.appendChild(commentsList);

      const renderComments = () => {
        commentsList.innerHTML = '';
        const comments = commentsForDoc().sort((a, b) => b.at - a.at);
        if (!comments.length) {
          const empty = document.createElement('p');
          empty.className = 'small';
          empty.textContent = 'A√∫n no hay comentarios. Comparte tu feedback para ayudar a otros.';
          commentsList.appendChild(empty);
          return;
        }
        comments.forEach(c => {
          const row = document.createElement('div');
          row.className = 'card';
          row.style.background = 'var(--surface-2)';
          row.style.marginTop = '8px';
          const user = state.users.find(u => u.id === c.userId);
          const label = c.value === 'useful' ? 'üëç √ötil' : c.value === 'not_useful' ? 'üëé No √∫til' : 'üí¨ Comentario';
          row.innerHTML = `
            <div class="flex space-between" style="gap:12px; align-items:flex-start;">
              <div class="grid" style="gap:6px;">
                <div class="flex" style="gap:8px; align-items:center;">
                  <strong>${user?.name || 'Usuario'}</strong>
                  <span class="tag">${label}</span>
                </div>
                <div class="small">${c.comment}</div>
              </div>
              <span class="small" style="white-space:nowrap;">${new Date(c.at).toLocaleString()}</span>
            </div>
          `;
          commentsList.appendChild(row);
        });
      };
      renderComments();
      container.appendChild(commentsCard);

      const versions = state.versions.filter(v => v.docId === doc.id).sort((a,b) => b.version - a.version);
      const history = document.createElement('div');
      history.className = 'card';
      history.innerHTML = `<h3>Historial de versiones</h3>${versions.length === 0 ? '<p class="small">Sin snapshots a√∫n.</p>' : ''}`;
      if (versions.length) {
        const list = document.createElement('table');
        list.className = 'table';
        list.innerHTML = '<tr><th>Versi√≥n</th><th>Estado</th><th>Fecha</th><th>Raz√≥n</th></tr>' + versions.map(v => `<tr><td>${v.version}</td><td>${v.status}</td><td>${new Date(v.snapshotAt).toLocaleString()}</td><td>${v.reason || 'guardado'}</td></tr>`).join('');
        history.appendChild(list);
      }
      container.appendChild(history);
      return container;

    }

    function renderEditor(id) {
      const editing = id && id !== 'new';
      const existing = editing ? state.docs.find(d => d.id === id) : null;
      let doc = existing ? { ...existing } : {
        id: `d${Date.now()}`,
        title: '',
        type: 'wiki',
        space: spaces[0],
        owner: state.currentUser.name,
        ownerId: state.currentUser.id,
        classification: 'interno',
        retentionDays: 365,
        audience: ['viewer','editor','admin','manager'],
        reviewEveryDays: 45,
        lastReviewedAt: Date.now(),
        status: 'draft',
        updatedAt: Date.now(),
        tags: [],
        content: '',
        version: 0,
        attachments: [],
        ext: 'html',
        mime: mimeFromExt('html'),
        sourceType: 'url',
        url: 'https://example.com'
      };
      const container = document.createElement('div');
      container.className = 'grid';
      if (!['editor','admin'].includes(state.currentUser.role)) {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = '<h2>No autorizado</h2>';
        container.appendChild(card);
        return container;
      }
      const card = document.createElement('div');
      card.className = 'card';
        card.innerHTML = `
          <div class="flex space-between">
            <h2>${editing ? 'Editar' : 'Crear'} documento</h2>
            <div class="status ${doc.status}">${doc.status}</div>
          </div>
          <div class="grid two">
            <div>
              <label>T√≠tulo</label>
              <input id="title" value="${doc.title}" />
            </div>
            <div>
              <label>Plantilla</label>
              <select id="template">
                <option value="">Seleccionar plantilla</option>
                <option value="sop">SOP</option>
                <option value="faq">FAQ</option>
                <option value="lesson">Lecci√≥n aprendida</option>
              </select>
            </div>
            <div>
              <label>Tipo</label>
              <select id="type">
                <option value="wiki">Wiki</option>
                <option value="faq">FAQ</option>
                <option value="procedimiento">Procedimiento</option>
                <option value="postmortem">Postmortem</option>
                <option value="playbook">Playbook</option>
              </select>
            </div>
            <div>
              <label>Espacio</label>
              <select id="space">${spaces.map(s => `<option value="${s}">${s}</option>`).join('')}</select>
            </div>
            <div>
              <label>Etiquetas (coma)</label>
              <input id="tags" list="tagSuggestions" value="${doc.tags.join(', ')}" />
              <datalist id="tagSuggestions">${TAXONOMY_CANONICAL.map(t => `<option value="${t}"></option>`).join('')}</datalist>
              <span class="small">Taxonom√≠a controlada: sugerimos ${TAXONOMY_CANONICAL.slice(0,6).join(', ')}...</span>
            </div>
            <div>
              <label>Owner (obligatorio)</label>
              <select id="owner">${state.users.map(u => `<option value="${u.id}">${u.name} (${u.role})</option>`).join('')}</select>
            </div>
            <div>
              <label>Clasificaci√≥n</label>
              <select id="classification">
                <option value="interno">Interno</option>
                <option value="confidencial">Confidencial</option>
                <option value="restringido">Restringido</option>
              </select>
            </div>
            <div>
              <label>Retenci√≥n (d√≠as)</label>
              <input id="retention" type="number" min="30" value="${doc.retentionDays || 365}" />
            </div>
          </div>
          <div class="grid two">
            <div>
              <label>Audiencia (roles)</label>
              <div id="audienceWrap" class="grid" style="grid-template-columns: repeat(auto-fit,minmax(140px,1fr)); gap:6px;"></div>
            </div>
            <div>
              <label>Ciclo de revisi√≥n</label>
              <div class="grid two">
                <div>
                  <label class="small">Cada (d√≠as)</label>
                  <input id="reviewEvery" type="number" min="7" value="${doc.reviewEveryDays || 45}" />
                </div>
                <div>
                  <label class="small">√öltima revisi√≥n</label>
                  <input id="lastReviewed" type="date" value="${new Date(doc.lastReviewedAt || Date.now()).toISOString().slice(0,10)}" />
                </div>
              </div>
              <div class="small" id="reviewPreview">Pr√≥xima revisi√≥n: --</div>
            </div>
          </div>
          <div class="grid two">
            <div>
              <label>Enlazar recurso (URL p√∫blica)</label>
              <input id="resourceUrl" value="${doc.url || ''}" placeholder="https://..." />
              <span class="small" id="resourceMeta"></span>
            </div>
            <div>
              <label>O subir archivo</label>
              <input id="resourceUpload" type="file" />
              <span class="small">Se almacenar√° como objectURL para esta sesi√≥n</span>
            </div>
          </div>
          <div>
            <label>Contenido</label>
            <textarea id="content">${doc.content}</textarea>
          </div>
          <div class="flex" style="margin-top:10px;">
          <button class="btn primary" id="saveBtn">Guardar versi√≥n</button>
          <button class="btn ghost" id="reviewBtn">Enviar a revisi√≥n</button>
          <button class="btn ghost" id="publishBtn">Aprobar y publicar</button>
        </div>
        <span class="small">Autosave cada ${autoSaveMs/1000}s ¬∑ Versi√≥n actual: ${doc.version || 0}</span>`;
      card.querySelector('#type').value = doc.type;
      card.querySelector('#space').value = doc.space;
      card.querySelector('#owner').value = doc.ownerId || state.currentUser.id;
      card.querySelector('#classification').value = doc.classification || 'interno';
      const templateSelector = card.querySelector('#template');
      templateSelector.onchange = (e) => {
        const tpl = templates[e.target.value];
        if (!tpl) return;
        card.querySelector('#title').value = tpl.title;
        card.querySelector('#content').value = tpl.content;
        if (tpl.title.startsWith('SOP')) card.querySelector('#type').value = 'procedimiento';
        if (tpl.title.startsWith('FAQ')) card.querySelector('#type').value = 'faq';
      };

      const audienceWrap = card.querySelector('#audienceWrap');
      const selectedAudience = new Set(doc.audience || ['viewer','editor','admin','manager']);
      ['viewer','editor','admin','manager'].forEach(role => {
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '6px';
        label.innerHTML = `<input type="checkbox" value="${role}" ${selectedAudience.has(role) ? 'checked' : ''}/> ${role}`;
        audienceWrap.appendChild(label);
      });

      const reviewPreview = card.querySelector('#reviewPreview');
      const reviewEveryInput = card.querySelector('#reviewEvery');
      const lastReviewedInput = card.querySelector('#lastReviewed');
      const refreshReviewPreview = () => {
        const every = Number(reviewEveryInput.value) || 30;
        const last = new Date(lastReviewedInput.value || new Date()).getTime();
        const computed = computeReviewFields({ ...doc, reviewEveryDays: every, lastReviewedAt: last });
        reviewPreview.textContent = `Pr√≥xima revisi√≥n: ${new Date(computed.nextReviewAt).toLocaleDateString()} ¬∑ Frescura: ${computed.freshness}`;
      };
      reviewEveryInput.oninput = refreshReviewPreview;
      lastReviewedInput.onchange = refreshReviewPreview;
      refreshReviewPreview();
      const updateResourceMeta = () => {
        const msg = `Fuente: ${doc.sourceType === 'upload' ? 'cargado' : 'enlace'} ¬∑ ${doc.ext?.toUpperCase() || 'sin ext'} ¬∑ ${doc.mime || ''}`;
        card.querySelector('#resourceMeta').textContent = msg;
      };
      updateResourceMeta();
      const urlInput = card.querySelector('#resourceUrl');
      urlInput.onblur = () => {
        const urlVal = urlInput.value.trim();
        if (!urlVal) return;
        const ext = extFromUrl(urlVal) || doc.ext;
        doc = { ...doc, url: urlVal, ext: normalizeExt(ext || doc.ext), mime: mimeFromExt(ext || doc.ext), sourceType: 'url' };
        updateResourceMeta();
      };
      const uploadInput = card.querySelector('#resourceUpload');
      uploadInput.onchange = (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        const ext = extFromUrl(file.name) || (file.type ? file.type.split('/').pop() : '') || doc.ext;
        doc = { ...doc, url, ext: normalizeExt(ext || ''), mime: file.type || mimeFromExt(ext || ''), sourceType: 'upload' };
        updateResourceMeta();
      };

      const assignAndPersist = (payload, reason) => {
        doc = upsertDoc(payload);
        createSnapshot(doc, reason);
      };
      card.querySelector('#saveBtn').onclick = () => {
        const payload = collectDocFields(card, doc, doc.status || 'draft');
        const isNew = !state.docs.find(d => d.id === payload.id);
        payload.version = (payload.version || 0) + 1;
        assignAndPersist(payload, 'guardar');
        logEvent(isNew ? 'doc_created' : 'doc_edited', { docId: payload.id, version: payload.version, mode: 'manual' });
        toast('Versi√≥n guardada');
        location.hash = `#/doc/${payload.id}`;
      };
      card.querySelector('#reviewBtn').onclick = () => {
        if (!['editor','admin'].includes(state.currentUser.role)) { toast('Solo editores pueden enviar a revisi√≥n'); return; }
        const payload = collectDocFields(card, doc, 'in_review');
        const isNew = !state.docs.find(d => d.id === payload.id);
        payload.version = (payload.version || 0) + 1;
        assignAndPersist(payload, 'env√≠o a revisi√≥n');
        logEvent(isNew ? 'doc_created' : 'doc_edited', { docId: payload.id, version: payload.version, mode: 'review' });
        logEvent('workflow_submitted', { docId: payload.id });
        toast('Enviado a revisi√≥n');
        location.hash = `#/doc/${payload.id}`;
      };
      card.querySelector('#publishBtn').onclick = () => {
        if (!['admin','manager'].includes(state.currentUser.role)) { toast('Solo admin/manager aprueban'); return; }
        if (doc.status !== 'in_review' && doc.status !== 'published') { toast('Debe estar en revisi√≥n para aprobar'); return; }
        const payload = collectDocFields(card, doc, 'published');
        payload.version = (payload.version || 0) + 1;
        assignAndPersist(payload, 'publicaci√≥n');
        logEvent('workflow_approved', { docId: payload.id });
        logEvent('doc_published', { docId: payload.id, version: payload.version });
        toast('Publicado');
        location.hash = `#/doc/${payload.id}`;
      };
      const autoSave = () => {
        const payload = collectDocFields(card, doc, doc.status);
        const exists = state.docs.some(d => d.id === payload.id);
        doc = upsertDoc(payload);
        logEvent(exists ? 'doc_edited' : 'doc_created', { docId: payload.id, mode: 'autosave' });
      };
      if (editorAutoSave) clearInterval(editorAutoSave);
      editorAutoSave = setInterval(autoSave, autoSaveMs);
      container.appendChild(card);
      return container;
    }

    function collectDocFields(card, base, statusOverride) {
      const title = card.querySelector('#title').value.trim() || 'Sin t√≠tulo';
      const type = card.querySelector('#type').value;
      const space = card.querySelector('#space').value;
      const tags = normalizeTags(card.querySelector('#tags').value.split(',').map(t => t.trim()).filter(Boolean));
      const ownerId = card.querySelector('#owner').value;
      if (!ownerId) { toast('Elige un owner'); throw new Error('owner requerido'); }
      const ownerUser = state.users.find(u => u.id === ownerId);
      const classification = card.querySelector('#classification').value;
      const retentionDays = Number(card.querySelector('#retention').value) || 365;
      const reviewEveryDays = Number(card.querySelector('#reviewEvery').value) || 45;
      const lastReviewedAt = new Date(card.querySelector('#lastReviewed').value || new Date()).getTime();
      const audience = Array.from(card.querySelectorAll('#audienceWrap input:checked')).map(i => i.value);
      const content = card.querySelector('#content').value;
      const nextReviewAt = lastReviewedAt + reviewEveryDays * 86400000;
      return { ...base, title, type, space, tags, content, owner: ownerUser?.name || base.owner || 'Sin owner', ownerId, classification, retentionDays, audience, reviewEveryDays, lastReviewedAt, nextReviewAt, freshness: computeReviewFields({ ...base, reviewEveryDays, lastReviewedAt, nextReviewAt }).freshness, status: statusOverride || base.status, updatedAt: Date.now(), version: base.version ?? 0, ext: base.ext || 'html', mime: base.mime || mimeFromExt(base.ext || 'html'), sourceType: base.sourceType || 'url', url: base.url || 'https://example.com' };
    }

    function upsertDoc(doc) {
      const normalizedDoc = computeReviewFields(doc);
      const idx = state.docs.findIndex(d => d.id === normalizedDoc.id);
      if (idx >= 0) {
        state.docs[idx] = normalizedDoc;
      } else {
        state.docs.push(normalizedDoc);
      }
      persist();
      return normalizedDoc;
    }

    function createSnapshot(doc, reason) {
      state.versions.push({
        id: crypto.randomUUID(),
        docId: doc.id,
        version: doc.version || 1,
        snapshotAt: Date.now(),
        status: doc.status,
        title: doc.title,
        content: doc.content,
        tags: doc.tags,
        type: doc.type,
        space: doc.space,
        ext: doc.ext || 'html',
        mime: doc.mime || mimeFromExt(doc.ext || 'html'),
        sourceType: doc.sourceType || 'url',
        url: doc.url || '',
        attachments: doc.attachments,
        reason
      });
      persist();
    }

    const staleThresholdDays = 20;
    const draftStuckDays = 10;

    function matchesSpace(event, space, docMap) {
      if (!space || space === 'all') return true;
      if (event.docId && docMap[event.docId]) return docMap[event.docId].space === space;
      if (event.space) return event.space === space;
      if (event.filters?.space) {
        const f = event.filters.space;
        return f === 'all' || f === space;
      }
      return false;
    }

    function filterEventsBy(range, space) {
      const cutoff = range === 'all' ? 0 : Date.now() - Number(range) * 86400000;
      const docMap = Object.fromEntries(state.docs.map(d => [d.id, d]));
      return getEvents().filter(e => e.at >= cutoff && matchesSpace(e, space, docMap));
    }

    function summarizeAnalytics(range, space) {
      const events = filterEventsBy(range, space);
      const now = Date.now();
      const docMap = Object.fromEntries(state.docs.map(d => [d.id, d]));
      const dayCutoff = now - 86400000;
      const weekCutoff = now - 7 * 86400000;
      const dau = new Set(events.filter(e => e.at >= dayCutoff).map(e => e.userId || e.user)).size;
      const wau = new Set(events.filter(e => e.at >= weekCutoff).map(e => e.userId || e.user)).size;
      const searches = events.filter(e => e.type === 'search_performed');
      const zeroResults = events.filter(e => e.type === 'search_zero_results' || e.type === 'zero_results');
      const docViews = events.filter(e => e.type === 'doc_viewed');
      const docViewCounts = {};
      docViews.forEach(ev => {
        const doc = docMap[ev.docId];
        if (!doc) return;
        docViewCounts[doc.id] = (docViewCounts[doc.id] || 0) + 1;
      });
      const topViewed = Object.entries(docViewCounts)
        .map(([id, count]) => ({ id, count, title: docMap[id]?.title || id }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 5);

      const feedbackWindow = state.feedback.filter(f => f.at >= (range === 'all' ? 0 : now - Number(range) * 86400000));
      const feedbackByDoc = {};
      feedbackWindow.forEach(f => {
        const doc = docMap[f.docId];
        if (!doc || !matchesSpace({ docId: f.docId }, space, docMap)) return;
        if (!feedbackByDoc[f.docId]) feedbackByDoc[f.docId] = { useful: 0, notUseful: 0, title: doc.title };
        if (f.value === 'useful') feedbackByDoc[f.docId].useful += 1; else feedbackByDoc[f.docId].notUseful += 1;
      });
      const topUseful = Object.entries(feedbackByDoc)
        .map(([id, stats]) => ({ id, score: stats.useful - stats.notUseful, ...stats }))
        .sort((a, b) => b.score - a.score)
        .slice(0, 5);

      const zeroGapMap = new Map();
      zeroResults.forEach(ev => {
        const key = ev.q || ev.query || 'consulta';
        const entry = zeroGapMap.get(key) || { q: key, zero: 0, low: 0, lastAt: ev.at, space: ev.filters?.space || 'all' };
        entry.zero += 1;
        entry.lastAt = Math.max(entry.lastAt, ev.at);
        zeroGapMap.set(key, entry);
      });

      state.gaps
        .filter(g => g.createdAt >= (range === 'all' ? 0 : now - Number(range) * 86400000))
        .filter(g => matchesSpace({ space: g.filters?.space || g.space }, space, docMap))
        .forEach(gap => {
          const key = gap.q || 'consulta';
          const entry = zeroGapMap.get(key) || { q: key, zero: 0, low: 0, lastAt: gap.createdAt, space: gap.filters?.space || 'all' };
          entry.zero += 1;
          entry.lastAt = Math.max(entry.lastAt, gap.createdAt);
          zeroGapMap.set(key, entry);
        });

      const lowClickMap = new Map();
      const viewsByUser = {};
      docViews.forEach(v => {
        if (!v.userId) return;
        if (!viewsByUser[v.userId]) viewsByUser[v.userId] = [];
        viewsByUser[v.userId].push(v.at);
      });
      searches.forEach(s => {
        if (!s.results || s.results === 0) return;
        const userViews = viewsByUser[s.userId] || [];
        const clicked = userViews.some(v => v >= s.at && v <= s.at + 120000);
        if (!clicked) {
          const key = s.q || 'consulta';
          const entry = lowClickMap.get(key) || { q: key, zero: 0, low: 0, lastAt: s.at, space: s.filters?.space || 'all' };
          entry.low += 1;
          entry.lastAt = Math.max(entry.lastAt, s.at);
          lowClickMap.set(key, entry);
        }
      });
      lowClickMap.forEach((v, k) => {
        const zeroEntry = zeroGapMap.get(k) || { q: k, zero: 0, low: 0, lastAt: v.lastAt, space: v.space };
        zeroEntry.low += v.low;
        zeroEntry.lastAt = Math.max(zeroEntry.lastAt, v.lastAt);
        zeroGapMap.set(k, zeroEntry);
      });

      const docsBySpace = state.docs.filter(d => space === 'all' || d.space === space);
      const health = {
        noOwner: docsBySpace.filter(d => !d.owner),
        stale: docsBySpace.filter(d => computeReviewFields(d).freshness === 'vencido'),
        dueSoon: docsBySpace.filter(d => computeReviewFields(d).freshness === 'por vencer'),
        drafts: docsBySpace.filter(d => d.status !== 'published' && now - d.updatedAt > draftStuckDays * 86400000)
      };

      return {
        dau,
        wau,
        searches: searches.length,
        zeroResults: zeroResults.length,
        zeroRate: searches.length ? Math.round((zeroResults.length / searches.length) * 100) : 0,
        topViewed,
        topUseful,
        gaps: Array.from(zeroGapMap.values()),
        health
      };
    }

    function drawBarChart(canvas, data, color = 'var(--accent)') {
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const width = canvas.clientWidth || 480;
      const height = 180;
      canvas.width = width;
      canvas.height = height;
      ctx.clearRect(0, 0, width, height);
      const max = Math.max(...data.map(d => d.value), 1);
      const barWidth = (width - 40) / data.length;
      data.forEach((d, i) => {
        const h = (d.value / max) * (height - 40);
        const x = 20 + i * barWidth;
        const y = height - h - 20;
        ctx.fillStyle = color;
        ctx.fillRect(x, y, barWidth * 0.7, h);
        ctx.fillStyle = 'var(--muted)';
        ctx.font = '12px Inter';
        ctx.fillText(d.label.slice(0, 10), x, height - 6);
        ctx.fillText(d.value, x, y - 4);
      });
    }

    function renderAnalytics() {
      if (!['admin','manager'].includes(state.currentUser.role)) {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = '<h2>No autorizado</h2>';
        return card;
      }
      const filters = state.config.analytics || seedState.config.analytics;
      const metrics = summarizeAnalytics(filters.range, filters.space);
      const wrapper = document.createElement('div');
      wrapper.className = 'grid';

      const controls = document.createElement('div');
      controls.className = 'card';
      controls.innerHTML = `
        <div class="flex space-between" style="align-items:center;">
          <div>
            <h2>Anal√≠tica</h2>
            <p class="small">Overview ¬∑ Search gaps ¬∑ Content health</p>
          </div>
          <div class="flex" style="gap:8px; flex-wrap:wrap;">
            <label class="small">Rango</label>
            <select id="rangeSel">
              <option value="7">7d</option>
              <option value="30">30d</option>
              <option value="90">90d</option>
              <option value="all">Todo</option>
            </select>
            <label class="small">Espacio</label>
            <select id="spaceSel">
              <option value="all">Todos</option>
              ${spaces.map(s => `<option value="${s}">${s}</option>`).join('')}
            </select>
            <button class="btn ghost" id="exportEvents">Exportar eventos (JSON)</button>
          </div>
        </div>
        <div class="flex" style="gap:8px; margin-top:10px;">
          ${['overview','gaps','health'].map(tab => `<button class="btn ${filters.tab===tab?'primary':'ghost'}" data-tab="${tab}">${tab === 'overview' ? 'Overview' : tab === 'gaps' ? 'Search gaps' : 'Content health'}</button>`).join('')}
        </div>`;
      const rangeSel = controls.querySelector('#rangeSel');
      rangeSel.value = filters.range;
      const spaceSel = controls.querySelector('#spaceSel');
      spaceSel.value = filters.space;
      controls.querySelector('#exportEvents').onclick = exportEvents;
      rangeSel.onchange = () => { state.config.analytics.range = rangeSel.value; persist(); render(); };
      spaceSel.onchange = () => { state.config.analytics.space = spaceSel.value; persist(); render(); };
      controls.querySelectorAll('[data-tab]').forEach(btn => btn.onclick = () => { state.config.analytics.tab = btn.dataset.tab; persist(); render(); });

      wrapper.appendChild(controls);
      const content = document.createElement('div');
      content.className = 'grid';
      if (filters.tab === 'overview') content.appendChild(renderAnalyticsOverview(metrics));
      if (filters.tab === 'gaps') content.appendChild(renderAnalyticsGaps(metrics, filters));
      if (filters.tab === 'health') content.appendChild(renderAnalyticsHealth(metrics, filters));
      wrapper.appendChild(content);
      return wrapper;
    }

    function metricTile(label, value, tone) {
      const color = tone === 'warning' ? 'var(--warning)' : 'var(--accent-2)';
      return `<div class="card" style="border-color:${color};"><h3>${label}</h3><div style="font-size:28px; font-weight:800;">${value}</div></div>`;
    }

    function renderAnalyticsOverview(metrics) {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="grid three">
          ${metricTile('DAU (aprox)', metrics.dau)}
          ${metricTile('WAU (aprox)', metrics.wau)}
          ${metricTile('B√∫squedas', metrics.searches)}
          ${metricTile('Zero results', `${metrics.zeroResults} (${metrics.zeroRate}% )`, metrics.zeroResults>0 ? 'warning' : '')}
          ${metricTile('Docs m√°s vistos', metrics.topViewed.length)}
          ${metricTile('Docs m√°s √∫tiles', metrics.topUseful.length)}
        </div>
        <div class="grid two" style="margin-top:12px;">
          <div class="card">
            <h4>Search vs Zero</h4>
            <canvas id="chart-search"></canvas>
          </div>
          <div class="card">
            <h4>Top vistos</h4>
            <canvas id="chart-views"></canvas>
          </div>
        </div>
        <div class="grid two" style="margin-top:12px;">
          <div>
            <h4>Docs m√°s vistos</h4>
            ${metrics.topViewed.map(d => `<div class="flex space-between"><span>${d.title}</span><span class="small">${d.count} vistas</span></div>`).join('') || '<p class="small">Sin datos a√∫n.</p>'}
          </div>
          <div>
            <h4>Docs m√°s √∫tiles</h4>
            ${metrics.topUseful.map(d => `<div class="flex space-between"><span>${d.title}</span><span class="small">Score ${d.score}</span></div>`).join('') || '<p class="small">Sin feedback a√∫n.</p>'}
          </div>
        </div>`;
      requestAnimationFrame(() => {
        const searchCanvas = card.querySelector('#chart-search');
        drawBarChart(searchCanvas, [
          { label: 'Search', value: metrics.searches },
          { label: 'Zero', value: metrics.zeroResults }
        ], 'var(--accent)');
        const viewCanvas = card.querySelector('#chart-views');
        const data = metrics.topViewed.map(d => ({ label: d.title, value: d.count }));
        drawBarChart(viewCanvas, data.length ? data : [{ label: 'N/A', value: 0 }], 'var(--accent-2)');
      });
      return card;
    }

    function renderAnalyticsGaps(metrics, filters) {
      const card = document.createElement('div');
      const sorted = [...metrics.gaps].sort((a, b) => {
        if (filters.gapSort === 'recent') return b.lastAt - a.lastAt;
        if (filters.gapSort === 'low') return (b.low || 0) - (a.low || 0);
        const byZero = (b.zero || 0) - (a.zero || 0);
        return byZero === 0 ? (b.low || 0) - (a.low || 0) : byZero;
      });
      const taskByGap = state.gapTasks.reduce((acc, t) => { acc[t.gapId] = t; return acc; }, {});
      card.className = 'card';
      card.innerHTML = `
        <div class="flex space-between" style="align-items:center;">
          <div>
            <h3>Search gaps</h3>
            <p class="small">Zero-results y low-click agrupados por consulta.</p>
          </div>
          <div class="flex" style="gap:8px;">
            <label class="small">Ordenar</label>
            <select id="gapSort">
              <option value="zero">Zero desc</option>
              <option value="low">Low-click desc</option>
              <option value="recent">Reciente</option>
            </select>
          </div>
        </div>
        <div class="table" style="width:100%; overflow:auto;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr><th>Consulta</th><th>Zero</th><th>Low-click</th><th>√öltima vez</th><th>Tarea</th><th>Acci√≥n</th></tr>
            </thead>
            <tbody id="gapRows"></tbody>
          </table>
        </div>`;
      card.querySelector('#gapSort').value = filters.gapSort || 'zero';
      card.querySelector('#gapSort').onchange = (e) => { state.config.analytics.gapSort = e.target.value; persist(); render(); };
      const tbody = card.querySelector('#gapRows');
      if (sorted.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="small">Sin gaps registrados.</td></tr>';
      } else {
        sorted.forEach(g => {
          const tr = document.createElement('tr');
          const task = taskByGap[g.id];
          tr.innerHTML = `<td>${g.q}</td><td>${g.zero || 0}</td><td>${g.low || 0}</td><td class="small">${new Date(g.lastAt).toLocaleString()}</td><td class="small">${task ? `Asignado a ${state.users.find(u => u.id===task.assignedTo)?.name || 'N/A'} ¬∑ vence ${new Date(task.dueAt).toLocaleDateString()}` : 'No asignado'}</td>`;
          const actionTd = document.createElement('td');
          const btn = document.createElement('button');
          btn.className = 'btn ghost small';
          btn.textContent = task ? 'Crear borrador' : 'Asignar + crear';
          btn.onclick = () => {
            let currentTask = taskByGap[g.id];
            if (!currentTask) currentTask = addGapTask({ gapId: g.id, assignedTo: state.currentUser.id, slaDays: 7 });
            const draft = createDocFromGap(g.id);
            toast('Borrador creado desde gap');
            if (draft) location.hash = `#/edit/${draft.id}`;
          };
          actionTd.appendChild(btn);
          tr.appendChild(actionTd);
          tbody.appendChild(tr);
        });
      }
      return card;
    }

    function renderAnalyticsHealth(metrics, filters) {
      const card = document.createElement('div');
      const healthSort = filters.healthSort || 'stale';
      const sortDocs = (list) => [...list].sort((a, b) => {
        if (healthSort === 'owner') return (a.owner || '').localeCompare(b.owner || '');
        return b.updatedAt - a.updatedAt;
      });
      const staleList = sortDocs(metrics.health.stale);
      const dueSoonList = sortDocs(metrics.health.dueSoon || []);
      const draftList = sortDocs(metrics.health.drafts);
      const noOwnerList = sortDocs(metrics.health.noOwner);
      card.className = 'card';
      card.innerHTML = `
        <div class="flex space-between" style="align-items:center;">
          <div>
            <h3>Content health</h3>
            <p class="small">Viejos, sin owner o estancados (draft/in review).</p>
          </div>
          <div class="flex" style="gap:8px;">
            <label class="small">Ordenar por</label>
            <select id="healthSort">
              <option value="stale">√öltima revisi√≥n</option>
              <option value="owner">Owner</option>
            </select>
          </div>
        </div>
        <div class="grid two" style="margin-top:12px;">
          ${metricTile('Sin owner', noOwnerList.length, noOwnerList.length ? 'warning' : '')}
          ${metricTile('Revisi√≥n vencida', staleList.length, staleList.length ? 'warning' : '')}
          ${metricTile('Por vencer', dueSoonList.length, dueSoonList.length ? 'warning' : '')}
          ${metricTile('Drafts estancados', draftList.length, draftList.length ? 'warning' : '')}
        </div>
        <div class="grid three" style="margin-top:12px;">
          <div>
            <h4>Sin owner</h4>
            ${noOwnerList.map(d => `<div class="flex space-between"><span>${d.title}</span><span class="small">${d.space}</span></div>`).join('') || '<p class="small">Todos tienen due√±o.</p>'}
          </div>
          <div>
            <h4>Revisi√≥n vencida</h4>
            ${staleList.map(d => `<div class="flex space-between"><span>${d.title}</span><span class="small">${new Date(d.nextReviewAt || d.updatedAt).toLocaleDateString()}</span></div>`).join('') || '<p class="small">Sin pendientes.</p>'}
          </div>
          <div>
            <h4>Por vencer (&lt;7d)</h4>
            ${dueSoonList.map(d => `<div class="flex space-between"><span>${d.title}</span><span class="small">${new Date(d.nextReviewAt || d.updatedAt).toLocaleDateString()}</span></div>`).join('') || '<p class="small">Sin pr√≥ximos vencimientos.</p>'}
          </div>
          <div>
            <h4>Draft/In review estancados</h4>
            ${draftList.map(d => `<div class="flex space-between"><span>${d.title}</span><span class="small">${d.status}</span></div>`).join('') || '<p class="small">Sin estancados.</p>'}
          </div>
        </div>`;
      const sortSel = card.querySelector('#healthSort');
      sortSel.value = healthSort;
      sortSel.onchange = (e) => { state.config.analytics.healthSort = e.target.value; persist(); render(); };
      return card;
    }

    window.addEventListener('hashchange', render);
    window.addEventListener('beforeunload', flushEvents);
    render();
  </script>
</body>
</html>
