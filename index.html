<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Repositorio de Conocimiento - Prototipo SPA</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b172a;
      --panel: #0f2038;
      --card: #112846;
      --accent: #ef845d;
      --accent-2: #5fe0c7;
      --text: #e6edf7;
      --muted: #9cb1d1;
      --border: #1d3557;
      --success: #4ade80;
      --warning: #facc15;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(95,224,199,0.08), transparent 32%),
                  radial-gradient(circle at 80% 0%, rgba(239,132,93,0.12), transparent 36%),
                  linear-gradient(180deg, #0b172a 0%, #0f1f35 36%, #0b172a 100%);
      color: var(--text);
      min-height: 100vh;
    }

    a { color: inherit; text-decoration: none; }

    .app-shell {
      display: grid;
      grid-template-columns: 240px 1fr;
      min-height: 100vh;
      transition: grid-template-columns 0.2s ease;
    }

    .sidebar {
      background: var(--panel);
      border-right: 1px solid var(--border);
      padding: 18px 14px;
      display: grid;
      gap: 14px;
      position: sticky;
      top: 0;
      height: 100vh;
    }

    .sidebar.collapsed { width: 68px; grid-template-columns: 1fr; }
    .sidebar.collapsed .label { display: none; }
    .sidebar.collapsed .nav-item { justify-content: center; }

    .sidebar .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 800;
      letter-spacing: 0.01em;
    }

    .brand-mark {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--accent), #f7b38f);
      color: #0b172a;
      display: grid;
      place-items: center;
      font-weight: 900;
      box-shadow: 0 12px 30px rgba(239,132,93,0.35);
    }

    .nav {
      display: grid;
      gap: 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      color: var(--muted);
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease;
      border: 1px solid transparent;
    }

    .nav-item:hover { background: rgba(255,255,255,0.06); color: #fff; border-color: var(--border); }
    .nav-item.active { background: rgba(239,132,93,0.14); color: #fff; border-color: rgba(239,132,93,0.35); }

    .topbar {
      background: rgba(15,32,56,0.92);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 5;
      padding: 12px 18px;
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: space-between;
    }

    .topbar .left, .topbar .right { display: flex; align-items: center; gap: 10px; }

    .search-box {
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 280px;
    }

    .search-box input {
      background: transparent;
      border: none;
      color: #fff;
      width: 100%;
      font-size: 14px;
      outline: none;
    }

    .btn {
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn.primary { background: var(--accent); color: #0b172a; box-shadow: 0 12px 30px rgba(239,132,93,0.25); }
    .btn.ghost { background: rgba(255,255,255,0.06); color: #fff; border: 1px solid var(--border); }

    .main {
      padding: 18px;
      display: grid;
      gap: 16px;
    }

    .card {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.16);
    }

    h1, h2, h3, h4 { margin: 0; }
    p { margin: 6px 0 0; color: var(--muted); }

    .grid { display: grid; gap: 12px; }
    .grid.two { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    .grid.three { grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(255,255,255,0.06);
      color: #fff;
      font-size: 12px;
      border: 1px solid var(--border);
    }

    .status { padding: 4px 8px; border-radius: 8px; font-weight: 700; font-size: 12px; text-transform: uppercase; }
    .status.draft { background: rgba(250,204,21,0.15); color: #facc15; }
    .status.in_review { background: rgba(94,234,212,0.15); color: #5fe0c7; }
    .status.published { background: rgba(74,222,128,0.18); color: #4ade80; }

    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { text-align: left; padding: 10px; border-bottom: 1px solid var(--border); }
    .table th { color: var(--muted); font-weight: 600; text-transform: uppercase; font-size: 12px; letter-spacing: 0.04em; }

    .doc-card { display: grid; gap: 6px; }

    .flex { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .space-between { justify-content: space-between; }

    .toast-container {
      position: fixed;
      bottom: 14px;
      right: 14px;
      display: grid;
      gap: 8px;
      z-index: 50;
    }

    .toast {
      background: rgba(17,40,70,0.95);
      border: 1px solid var(--border);
      color: #fff;
      padding: 12px 14px;
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.24);
      min-width: 220px;
    }

    .login-wrapper {
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 20px;
    }

    .login-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      width: min(420px, 90vw);
      box-shadow: 0 16px 40px rgba(0,0,0,0.22);
      display: grid;
      gap: 12px;
    }

    label { font-weight: 600; color: #dce7f5; font-size: 14px; }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: #fff;
      font-family: inherit;
    }

    textarea { min-height: 160px; }

    .badge { background: rgba(255,255,255,0.08); padding: 6px 10px; border-radius: 10px; font-weight: 700; }
    .small { font-size: 12px; color: var(--muted); }

    .tag { background: rgba(255,255,255,0.07); padding: 4px 8px; border-radius: 8px; font-size: 12px; }
  </style>
</head>
<body>
  <div id="app"></div>
  <div class="toast-container" id="toasts"></div>

  <script type="module">
    const storageKey = 'kb-demo-state-v1';

    const seedUsers = [
      { id: 'u1', name: 'Ana Viewer', email: 'ana@demo.local', role: 'viewer', password: 'demo' },
      { id: 'u2', name: 'Bruno Editor', email: 'bruno@demo.local', role: 'editor', password: 'demo' },
      { id: 'u3', name: 'Camila Admin', email: 'camila@demo.local', role: 'admin', password: 'demo' }
    ];

    const spaces = ['TI', 'Operaciones', 'Comercial', 'Talento'];
    const tagsPool = ['SOP', 'FAQ', 'Postmortem', 'Playbook', 'Onboarding', 'Incidente', 'Ventas'];
    const templates = {
      sop: {
        title: 'SOP: Proceso est√°ndar',
        content: 'Objetivo\nAlcance\nPre-requisitos\nPasos\nRoles y RACI\nValidaci√≥n y evidencia'
      },
      faq: {
        title: 'FAQ: Pregunta frecuente',
        content: 'Pregunta\nRespuesta breve\nDetalles adicionales\nEnlaces relacionados'
      },
      lesson: {
        title: 'Lecci√≥n aprendida',
        content: 'Situaci√≥n\nCausa ra√≠z\nImpacto\nAcciones correctivas\nRecomendaciones futuras'
      }
    };

    const seedDocs = Array.from({ length: 10 }).map((_, i) => ({
      id: `d${i+1}`,
      title: `Documento ${i+1} - ${['SOP','FAQ','Playbook','Caso','Gu√≠a'][i%5]}`,
      type: ['wiki','faq','procedimiento','postmortem','playbook'][i%5],
      space: spaces[i % spaces.length],
      owner: seedUsers[i % seedUsers.length].name,
      status: ['draft','in_review','published'][i % 3],
      updatedAt: Date.now() - i * 86400000,
      tags: [tagsPool[i % tagsPool.length], tagsPool[(i+2)%tagsPool.length]],
      content: `Contenido de ejemplo para el documento ${i+1}. Incluye contexto de ${spaces[i % spaces.length]} y etiqueta ${tagsPool[i % tagsPool.length]}.`,
      views: Math.floor(Math.random() * 120) + 4,
      version: 1
    }));

    const seedVersions = seedDocs.map(doc => ({
      id: crypto.randomUUID(),
      docId: doc.id,
      version: 1,
      snapshotAt: doc.updatedAt,
      status: doc.status,
      title: doc.title,
      content: doc.content,
      tags: doc.tags,
      type: doc.type,
      space: doc.space
    }));

    const seedState = {
      users: seedUsers,
      docs: seedDocs,
      events: [],
      gaps: [],
      feedback: [],
      follows: [],
      versions: seedVersions,
      config: { iaEnabled: true, versioning: true, locale: 'es' },
      currentUser: null,
      session: null,
      sidebarCollapsed: false
    };

    const state = loadState();
    let editorAutoSave = null;
    const autoSaveMs = 8000;

    if (state.session && !state.currentUser) {
      const user = state.users.find(u => u.id === state.session.userId);
      if (user) state.currentUser = user;
    }

    function loadState() {
      const raw = localStorage.getItem(storageKey);
      if (!raw) return structuredClone(seedState);
        try {
          const parsed = JSON.parse(raw);
          return {
            ...structuredClone(seedState),
            ...parsed,
            session: parsed.session ?? null,
            feedback: parsed.feedback ?? [],
            follows: parsed.follows ?? [],
            versions: parsed.versions ?? seedVersions
          };
        } catch (e) {
        console.warn('Estado corrupto, reseteando');
        return structuredClone(seedState);
      }
    }

    function persist() {
      localStorage.setItem(storageKey, JSON.stringify(state));
    }

    function resetDemo() {
      localStorage.removeItem(storageKey);
      Object.assign(state, structuredClone(seedState));
      render();
      toast('Datos de demo restaurados');
    }

    function toast(message) {
      const container = document.getElementById('toasts');
      const node = document.createElement('div');
      node.className = 'toast';
      node.textContent = message;
      container.appendChild(node);
      setTimeout(() => node.remove(), 2600);
    }

    function logEvent(type, payload = {}) {
      state.events.push({ id: crypto.randomUUID(), type, at: Date.now(), user: state.currentUser?.email || 'anon', ...payload });
      persist();
    }

    function setUser(user) {
      state.currentUser = user;
      persist();
    }

    function setSession(session) {
      state.session = session;
      if (!session) state.currentUser = null;
      persist();
    }

    function requireAuth(target) {
      if ((!state.currentUser || !state.session?.token) && target !== '/login') {
        location.hash = '#/login';
        return false;
      }
      return true;
    }

    function router() {
      const hash = location.hash.slice(1) || '/login';
      const clean = hash.split('?')[0];
      const [path, param] = clean.split('/').filter(Boolean);
      const routes = {
        'login': '/login',
        'home': '/home',
        'search': '/search',
        'doc': '/doc',
        'edit': '/edit',
        'analytics': '/analytics'
      };
      const key = routes[path] || '/login';
      if (!requireAuth(key)) return { key: '/login' };
      if (key === '/analytics' && !['admin','manager'].includes(state.currentUser.role)) {
        toast('Necesitas rol admin/manager para Anal√≠tica');
        location.hash = '#/home';
        return { key: '/home' };
      }
      return { key, param };
    }

    function render() {
      const { key, param } = router();
      if (key !== '/edit' && editorAutoSave) { clearInterval(editorAutoSave); editorAutoSave = null; }
      if (key === '/login') {
        renderLogin();
        return;
      }
      const app = document.getElementById('app');
      app.innerHTML = '';
      const shell = document.createElement('div');
      shell.className = 'app-shell';
      const sidebar = renderSidebar(key);
      const content = document.createElement('div');
      content.style.display = 'flex';
      content.style.flexDirection = 'column';
      const topbar = renderTopbar();
      const main = document.createElement('div');
      main.className = 'main';
      switch (key) {
        case '/home': main.appendChild(renderHome()); break;
        case '/search': main.appendChild(renderSearch()); break;
        case '/doc': main.appendChild(renderDoc(param)); break;
        case '/edit': main.appendChild(renderEditor(param)); break;
        case '/analytics': main.appendChild(renderAnalytics()); break;
        default: main.appendChild(renderHome());
      }
      content.appendChild(topbar);
      content.appendChild(main);
      shell.appendChild(sidebar);
      shell.appendChild(content);
      app.replaceChildren(shell);
    }

    function renderSidebar(active) {
      const navItems = [
        { href: '#/home', label: 'Home' },
        { href: '#/search', label: 'B√∫squeda' },
        { href: '#/edit/new', label: 'Crear', roles: ['editor','admin'] },
        { href: '#/analytics', label: 'Anal√≠tica', roles: ['admin','manager'] },
      ];
      const aside = document.createElement('aside');
      aside.className = 'sidebar' + (state.sidebarCollapsed ? ' collapsed' : '');
      const brand = document.createElement('div');
      brand.className = 'brand';
      brand.innerHTML = `<div class="brand-mark">T</div><span class="label">Repositorio</span>`;
      const collapseBtn = document.createElement('button');
      collapseBtn.className = 'btn ghost';
      collapseBtn.style.width = '100%';
      collapseBtn.textContent = state.sidebarCollapsed ? 'Expandir' : 'Colapsar';
      collapseBtn.onclick = () => { state.sidebarCollapsed = !state.sidebarCollapsed; persist(); render(); };
      const nav = document.createElement('div');
      nav.className = 'nav';
      navItems.forEach(item => {
        if (item.roles && !item.roles.includes(state.currentUser.role)) return;
        const link = document.createElement('a');
        link.href = item.href;
        link.className = 'nav-item' + (location.hash.startsWith(item.href) ? ' active' : '');
        link.innerHTML = `<span class="label">${item.label}</span>`;
        nav.appendChild(link);
      });
      const resetBtn = document.createElement('button');
      resetBtn.className = 'btn ghost';
      resetBtn.innerHTML = '<span class="label">Reset demo</span>';
      resetBtn.onclick = resetDemo;
      aside.append(brand, nav, collapseBtn, resetBtn);
      return aside;
    }

    function renderTopbar() {
      const bar = document.createElement('div');
      bar.className = 'topbar';
      const left = document.createElement('div');
      left.className = 'left';
      const quickSearch = document.createElement('div');
      quickSearch.className = 'search-box';
      quickSearch.innerHTML = '<span>üîç</span><input placeholder="Buscar..." aria-label="Buscar" />';
      const input = quickSearch.querySelector('input');
      input.onkeydown = (e) => {
        if (e.key === 'Enter') {
          const q = input.value.trim();
          if (q) {
            state.lastQuery = q;
            logEvent('search_performed', { q });
            location.hash = '#/search?q=' + encodeURIComponent(q);
          }
        }
      };
      left.appendChild(quickSearch);
      const right = document.createElement('div');
      right.className = 'right';
      const createBtn = document.createElement('button');
      createBtn.className = 'btn primary';
      createBtn.textContent = 'Crear';
      createBtn.disabled = !['editor','admin'].includes(state.currentUser.role);
      createBtn.onclick = () => { location.hash = '#/edit/new'; };
      const userBadge = document.createElement('div');
      userBadge.className = 'pill';
      userBadge.textContent = `${state.currentUser.name} ¬∑ ${state.currentUser.role}`;
      const logout = document.createElement('button');
      logout.className = 'btn ghost';
      logout.textContent = 'Salir';
      logout.onclick = () => { setSession(null); location.hash = '#/login'; };
      right.append(createBtn, userBadge, logout);
      bar.append(left, right);
      return bar;
    }

    function renderLogin() {
      const app = document.getElementById('app');
      app.innerHTML = '';
      const wrapper = document.createElement('div');
      wrapper.className = 'login-wrapper';
      const card = document.createElement('div');
      card.className = 'login-card';
      card.innerHTML = `
        <h2>Acceder</h2>
        <p>Inicia sesi√≥n con credenciales demo o simula SSO. El acceso est√° sujeto a pol√≠ticas corporativas.</p>
        <div class="grid">
          <button class="btn primary" id="ssoBtn">Ingresar con SSO</button>
          <div class="grid">
            <label for="email">Correo</label>
            <input id="email" placeholder="usuario@demo.local" />
            <label for="password">Clave</label>
            <input id="password" type="password" placeholder="demo" />
            <label for="role">Rol</label>
            <select id="role">
              <option value="viewer">viewer</option>
              <option value="editor">editor</option>
              <option value="admin">admin</option>
              <option value="manager">manager</option>
            </select>
          </div>
          <button class="btn ghost" id="loginBtn">Ingresar</button>
          <span class="small">Demo: elige un usuario para autocompletar</span>
          <div class="flex" id="demoUsers"></div>
        </div>`;
      const demoUsers = card.querySelector('#demoUsers');
      state.users.forEach(u => {
        const b = document.createElement('button');
        b.className = 'btn ghost';
        b.textContent = `${u.name} (${u.role})`;
        b.onclick = () => {
          card.querySelector('#email').value = u.email;
          card.querySelector('#password').value = 'demo';
          card.querySelector('#role').value = u.role;
        };
        demoUsers.appendChild(b);
      });
      card.querySelector('#ssoBtn').onclick = () => {
        toast('Simulando redirecci√≥n SSO...');
        setTimeout(() => toast('SSO completado (demo)'), 800);
      };
      card.querySelector('#loginBtn').onclick = () => {
        const email = card.querySelector('#email').value.trim();
        const pass = card.querySelector('#password').value.trim();
        const role = card.querySelector('#role').value;
        const user = state.users.find(u => u.email === email && u.password === pass);
        if (!user) { toast('Credenciales inv√°lidas'); return; }
        if (role !== user.role) { toast('Rol no coincide con el usuario demo'); return; }
        const token = crypto.randomUUID();
        setUser(user);
        setSession({ token, userId: user.id, role: user.role, issuedAt: Date.now() });
        logEvent('login_success', { email, role });
        location.hash = '#/home';
      };
      wrapper.appendChild(card);
      app.appendChild(wrapper);
    }

    function renderHome() {
      const container = document.createElement('div');
      container.className = 'grid';
      const hero = document.createElement('div');
      hero.className = 'card';
      hero.innerHTML = `
        <div class="flex space-between"><h2>Inicio</h2><span class="badge">Rol: ${state.currentUser.role}</span></div>
        <p>Busca, consume y crea conocimiento. Feed personalizado y tareas r√°pidas.</p>
        <div class="grid two">
          <div>
            <label for="home-search">Buscar</label>
            <div class="search-box" style="margin-top:6px;">
              <span>üîç</span>
              <input id="home-search" placeholder="Buscar en todo..." />
            </div>
          </div>
          <div class="grid" style="align-content:end;">
            <div class="flex" style="gap:8px; flex-wrap:wrap;">
              <button class="btn primary" id="home-search-btn">Buscar</button>
              <button class="btn ghost" onclick="location.hash='#/edit/new'" ${['editor','admin'].includes(state.currentUser.role) ? '' : 'disabled'}>Crear art√≠culo</button>
              <button class="btn ghost" onclick="location.hash='#/analytics'" ${['admin','manager'].includes(state.currentUser.role) ? '' : 'disabled'}>Ver anal√≠tica</button>
            </div>
            <span class="small">Tip: usa filtros avanzados en la vista de b√∫squeda</span>
          </div>
        </div>`;
      const homeSearchInput = hero.querySelector('#home-search');
      hero.querySelector('#home-search-btn').onclick = () => {
        const q = homeSearchInput.value.trim();
        logEvent('search_performed', { from: 'home', q });
        location.hash = `#/search?q=${encodeURIComponent(q)}`;
      };
      const feeds = document.createElement('div');
      feeds.className = 'grid two';
      feeds.append(
        buildListCard('Recientes', recentDocs(4)),
        buildListCard('Populares', topDocsByViews(4))
      );
      const tasks = document.createElement('div');
      tasks.className = 'card';
      const pending = state.docs.filter(d => d.status === 'in_review');
      tasks.innerHTML = `<div class="flex space-between"><h3>Workflow</h3><span class="small">Draft ‚Üí Review ‚Üí Published</span></div>`;
      if (pending.length === 0) {
        tasks.innerHTML += '<p>No hay documentos en revisi√≥n.</p>';
      } else {
        const ul = document.createElement('div');
        ul.className = 'grid';
        pending.forEach(d => {
          const row = document.createElement('div');
          row.className = 'flex space-between';
          row.innerHTML = `<span>${d.title}</span><div class="status ${d.status}">${d.status}</div>`;
          ul.appendChild(row);
        });
        tasks.appendChild(ul);
      }
      container.append(hero, feeds, tasks);
      return container;
    }

    function buildListCard(title, docs) {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<h3>${title}</h3>`;
      docs.forEach(doc => {
        const div = document.createElement('div');
        div.className = 'doc-card';
        div.innerHTML = `
          <div class="flex space-between">
            <a href="#/doc/${doc.id}" class="pill">${doc.title}</a>
            <span class="status ${doc.status}">${doc.status}</span>
          </div>
          <div class="flex">
            <span class="small">${doc.space}</span>
            <span class="small">${new Date(doc.updatedAt).toLocaleDateString()}</span>
          </div>`;
        card.appendChild(div);
      });
      return card;
    }

    function topDocsByViews(n) {
      return [...state.docs].sort((a,b) => b.views - a.views).slice(0,n);
    }
    function recentDocs(n) {
      return [...state.docs].sort((a,b) => b.updatedAt - a.updatedAt).slice(0,n);
    }

    function parseQuery() {
      const hash = location.hash.split('?')[1] || '';
      return Object.fromEntries(new URLSearchParams(hash));
    }

    function renderSearch() {
      const params = parseQuery();
      const q = params.q || '';
      const type = params.type || 'all';
      const space = params.space || 'all';
      const tags = params.tags ? params.tags.split(',').map(t => t.trim()).filter(Boolean) : [];
      const range = params.range || 'all';
      const results = searchDocs({ q, type, space, tags, range });
      const attempted = q || type !== 'all' || space !== 'all' || tags.length > 0 || range !== 'all';
      if (attempted) {
        logEvent('search_performed', { q, filters: { type, space, tags, range }, results: results.length });
        if (results.length === 0) logEvent('search_zero_results', { q, filters: { type, space, tags, range } });
      }
      const container = document.createElement('div');
      container.className = 'grid';
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="flex space-between"><h2>B√∫squeda</h2><span class="small">Full-text + filtros</span></div>
        <div class="grid two">
          <div>
            <label>Consulta</label>
            <input id="q" value="${q}" placeholder="Buscar..." />
          </div>
          <div class="grid two">
            <div>
              <label>Tipo</label>
              <select id="type">
                <option value="all">Todos</option>
                <option value="wiki">Wiki</option>
                <option value="faq">FAQ</option>
                <option value="procedimiento">Procedimiento</option>
                <option value="postmortem">Postmortem</option>
                <option value="playbook">Playbook</option>
              </select>
            </div>
            <div>
              <label>Espacio</label>
              <select id="space">
                <option value="all">Todos</option>
                ${spaces.map(s => `<option value="${s}">${s}</option>`).join('')}
              </select>
            </div>
          </div>
        </div>
        <div class="grid two" style="margin-top:10px;">
          <div>
            <label>Etiquetas (coma)</label>
            <input id="tags" value="${tags.join(', ')}" placeholder="SOP, FAQ" />
          </div>
          <div>
            <label>Fecha de actualizaci√≥n</label>
            <select id="range">
              <option value="all">Cualquier fecha</option>
              <option value="7">√öltimos 7 d√≠as</option>
              <option value="30">√öltimos 30 d√≠as</option>
              <option value="90">√öltimos 90 d√≠as</option>
            </select>
          </div>
        </div>
        <div class="flex" style="margin-top:10px;">
          <button class="btn primary" id="runSearch">Buscar</button>
          <span class="small">Resultados: ${results.length}</span>
        </div>`;
      const typeSel = card.querySelector('#type');
      typeSel.value = type;
      const spaceSel = card.querySelector('#space');
      spaceSel.value = space;
      const rangeSel = card.querySelector('#range');
      rangeSel.value = range;
      card.querySelector('#runSearch').onclick = () => {
        const nextQ = card.querySelector('#q').value.trim();
        const nextType = typeSel.value;
        const nextSpace = spaceSel.value;
        const nextTags = card.querySelector('#tags').value.split(',').map(t => t.trim()).filter(Boolean);
        const nextRange = rangeSel.value;
        const previewResults = searchDocs({ q: nextQ, type: nextType, space: nextSpace, tags: nextTags, range: nextRange });
        logEvent('search_performed', { q: nextQ, filters: { type: nextType, space: nextSpace, tags: nextTags, range: nextRange }, results: previewResults.length, source: 'search_form' });
        if (previewResults.length === 0) logEvent('search_zero_results', { q: nextQ, filters: { type: nextType, space: nextSpace, tags: nextTags, range: nextRange } });
        location.hash = `#/search?q=${encodeURIComponent(nextQ)}&type=${nextType}&space=${nextSpace}&tags=${encodeURIComponent(nextTags.join(','))}&range=${nextRange}`;
      };
      const list = document.createElement('div');
      list.className = 'grid two';
      if (results.length === 0 && attempted) {
        const empty = document.createElement('div');
        empty.className = 'card';
        empty.innerHTML = `<h3>Sin resultados</h3><p class="small">No encontramos coincidencias. Reporta un gap para generar contenido.</p><button class="btn primary" id="reportGap">Reportar gap</button>`;
        empty.querySelector('#reportGap').onclick = () => {
          addGap({ q, filters: { type, space, tags, range } });
          toast('Gap registrado');
        };
        list.appendChild(empty);
      }
      results.forEach(r => {
        const item = document.createElement('div');
        item.className = 'card doc-card';
        item.innerHTML = `
          <div class="flex space-between">
            <a href="#/doc/${r.id}"><h3>${r.title}</h3></a>
            <span class="status ${r.status}">${r.status}</span>
          </div>
          <p>${r.content.slice(0,120)}...</p>
          <div class="flex">
            <span class="tag">${r.type}</span>
            <span class="tag">${r.space}</span>
            ${r.tags.map(t => `<span class="tag">${t}</span>`).join('')}
          </div>`;
        list.appendChild(item);
      });
      container.append(card, list);
      return container;
    }

    function searchDocs({ q = '', type = 'all', space = 'all', tags = [], range = 'all' }) {
      const normalized = q.trim().toLowerCase();
      const now = Date.now();
      const rangeDays = range === 'all' ? null : Number(range);
      return state.docs.filter(d => {
        const haystack = `${d.title} ${d.content} ${d.tags.join(' ')}`.toLowerCase();
        const matchesQ = normalized ? haystack.includes(normalized) : true;
        const matchesType = type === 'all' || d.type === type;
        const matchesSpace = space === 'all' || d.space === space;
        const matchesTags = tags.length === 0 || tags.every(t => d.tags.map(x => x.toLowerCase()).includes(t.toLowerCase()));
        const matchesDate = !rangeDays || d.updatedAt >= now - rangeDays * 86400000;
        return matchesQ && matchesType && matchesSpace && matchesTags && matchesDate;
      });
    }

    function addGap(payload) {
      const gap = { id: `gap-${Date.now()}`, ...payload, reporter: state.currentUser?.email || 'anon', createdAt: Date.now() };
      state.gaps.push(gap);
      logEvent('gap_reported', gap);
      persist();
    }

    function isFollowing(docId, userId = state.currentUser?.id) {
      if (!userId) return false;
      return state.follows.some(f => f.docId === docId && f.userId === userId);
    }

    function toggleFollow(docId) {
      const userId = state.currentUser?.id;
      if (!userId) return;
      const idx = state.follows.findIndex(f => f.docId === docId && f.userId === userId);
      if (idx >= 0) {
        state.follows.splice(idx, 1);
        logEvent('doc_unfollowed', { docId, userId });
        toast('Se dej√≥ de seguir');
      } else {
        state.follows.push({ id: crypto.randomUUID(), docId, userId, at: Date.now() });
        logEvent('doc_followed', { docId, userId });
        toast('Siguiendo documento');
      }
      persist();
    }

    function saveFeedback(docId, value, comment) {
      const entry = {
        id: crypto.randomUUID(),
        docId,
        value,
        comment: comment?.trim() || '',
        userId: state.currentUser?.id,
        at: Date.now()
      };
      state.feedback.push(entry);
      logEvent('doc_feedback', { docId, value, hasComment: !!entry.comment });
      persist();
    }

    function feedbackSummary(docId) {
      const items = state.feedback.filter(f => f.docId === docId);
      const useful = items.filter(f => f.value === 'useful').length;
      const notUseful = items.filter(f => f.value === 'not_useful').length;
      return { useful, notUseful, total: items.length };
    }

    function renderDoc(id) {
      const doc = state.docs.find(d => d.id === id);
      const container = document.createElement('div');
      container.className = 'grid';
      if (!doc) {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = '<h2>Documento no encontrado</h2>';
        container.appendChild(card);
        return container;
      }
      doc.views += 1;
      logEvent('doc_viewed', { docId: doc.id, status: doc.status });
      persist();
      const stats = feedbackSummary(doc.id);
      const followers = () => state.follows.filter(f => f.docId === doc.id).length;
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="flex space-between">
          <div>
            <h2>${doc.title}</h2>
            <div class="flex">
              <span class="tag">${doc.type}</span>
              <span class="tag">${doc.space}</span>
              ${doc.tags.map(t => `<span class="tag">${t}</span>`).join('')}
              <span class="tag">Owner: ${doc.owner}</span>
            </div>
          </div>
          <div class="flex">
            <div class="status ${doc.status}">${doc.status}</div>
            ${['editor','admin'].includes(state.currentUser.role) ? `<button class="btn ghost" onclick="location.hash='#/edit/${doc.id}'">Editar</button>` : ''}
          </div>
        </div>
        <p>${doc.content}</p>
        <div class="flex">
          <button class="btn primary" id="useful">üëç √ötil</button>
          <button class="btn ghost" id="notUseful">üëé No √∫til</button>
          <button class="btn ghost" id="follow">${isFollowing(doc.id) ? 'Siguiendo' : 'Seguir'}</button>
          <button class="btn ghost" id="report">Reportar obsoleto</button>
        </div>
        <div class="grid" style="margin-top:8px;">
          <label for="comment">Comentario (opcional)</label>
          <textarea id="comment" placeholder="Agrega contexto para mejorar el art√≠culo"></textarea>
        </div>
        <span class="small" id="statsLine">Feedback: ${stats.useful} üëç / ${stats.notUseful} üëé ¬∑ Seguidores: ${followers()}</span>
        <span class="small">√öltima actualizaci√≥n: ${new Date(doc.updatedAt).toLocaleString()} ¬∑ Vistas: ${doc.views}</span>`;
      const commentInput = card.querySelector('#comment');
      const statsLine = card.querySelector('#statsLine');
      const followBtn = card.querySelector('#follow');
      const refreshStats = () => {
        const next = feedbackSummary(doc.id);
        statsLine.textContent = `Feedback: ${next.useful} üëç / ${next.notUseful} üëé ¬∑ Seguidores: ${followers()}`;
        followBtn.textContent = isFollowing(doc.id) ? 'Siguiendo' : 'Seguir';
      };
      card.querySelector('#useful').onclick = () => {
        saveFeedback(doc.id, 'useful', commentInput.value);
        commentInput.value = '';
        toast('Feedback registrado');
        refreshStats();
      };
      card.querySelector('#notUseful').onclick = () => {
        saveFeedback(doc.id, 'not_useful', commentInput.value);
        commentInput.value = '';
        toast('Gracias por el feedback');
        refreshStats();
      };
      followBtn.onclick = () => { toggleFollow(doc.id); refreshStats(); };
      card.querySelector('#report').onclick = () => { logEvent('doc_outdated_reported', { docId: doc.id }); toast('Reporte enviado'); };
      container.appendChild(card);
      const versions = state.versions.filter(v => v.docId === doc.id).sort((a,b) => b.version - a.version);
      const history = document.createElement('div');
      history.className = 'card';
      history.innerHTML = `<h3>Historial de versiones</h3>${versions.length === 0 ? '<p class="small">Sin snapshots a√∫n.</p>' : ''}`;
      if (versions.length) {
        const list = document.createElement('table');
        list.className = 'table';
        list.innerHTML = '<tr><th>Versi√≥n</th><th>Estado</th><th>Fecha</th><th>Raz√≥n</th></tr>' + versions.map(v => `<tr><td>${v.version}</td><td>${v.status}</td><td>${new Date(v.snapshotAt).toLocaleString()}</td><td>${v.reason || 'guardado'}</td></tr>`).join('');
        history.appendChild(list);
      }
      container.appendChild(history);
      return container;

    }

    function renderEditor(id) {
      const editing = id && id !== 'new';
      const existing = editing ? state.docs.find(d => d.id === id) : null;
      let doc = existing ? { ...existing } : {
        id: `d${Date.now()}`,
        title: '',
        type: 'wiki',
        space: spaces[0],
        owner: state.currentUser.name,
        status: 'draft',
        updatedAt: Date.now(),
        tags: [],
        content: '',
        version: 0
      };
      const container = document.createElement('div');
      container.className = 'grid';
      if (!['editor','admin'].includes(state.currentUser.role)) {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = '<h2>No autorizado</h2>';
        container.appendChild(card);
        return container;
      }
      const card = document.createElement('div');
      card.className = 'card';
        card.innerHTML = `
          <div class="flex space-between">
            <h2>${editing ? 'Editar' : 'Crear'} documento</h2>
            <div class="status ${doc.status}">${doc.status}</div>
          </div>
          <div class="grid two">
            <div>
              <label>T√≠tulo</label>
              <input id="title" value="${doc.title}" />
            </div>
            <div>
              <label>Plantilla</label>
              <select id="template">
                <option value="">Seleccionar plantilla</option>
                <option value="sop">SOP</option>
                <option value="faq">FAQ</option>
                <option value="lesson">Lecci√≥n aprendida</option>
              </select>
            </div>
            <div>
              <label>Tipo</label>
              <select id="type">
                <option value="wiki">Wiki</option>
                <option value="faq">FAQ</option>
                <option value="procedimiento">Procedimiento</option>
                <option value="postmortem">Postmortem</option>
                <option value="playbook">Playbook</option>
              </select>
            </div>
            <div>
              <label>Espacio</label>
              <select id="space">${spaces.map(s => `<option value="${s}">${s}</option>`).join('')}</select>
            </div>
            <div>
              <label>Etiquetas (coma)</label>
              <input id="tags" value="${doc.tags.join(', ')}" />
            </div>
          </div>
          <div>
            <label>Contenido</label>
            <textarea id="content">${doc.content}</textarea>
          </div>
          <div class="flex" style="margin-top:10px;">
          <button class="btn primary" id="saveBtn">Guardar versi√≥n</button>
          <button class="btn ghost" id="reviewBtn">Enviar a revisi√≥n</button>
          <button class="btn ghost" id="publishBtn">Aprobar y publicar</button>
        </div>
        <span class="small">Autosave cada ${autoSaveMs/1000}s ¬∑ Versi√≥n actual: ${doc.version || 0}</span>`;
      card.querySelector('#type').value = doc.type;
      card.querySelector('#space').value = doc.space;
      const templateSelector = card.querySelector('#template');
      templateSelector.onchange = (e) => {
        const tpl = templates[e.target.value];
        if (!tpl) return;
        card.querySelector('#title').value = tpl.title;
        card.querySelector('#content').value = tpl.content;
        if (tpl.title.startsWith('SOP')) card.querySelector('#type').value = 'procedimiento';
        if (tpl.title.startsWith('FAQ')) card.querySelector('#type').value = 'faq';
      };
      const assignAndPersist = (payload, reason) => {
        doc = upsertDoc(payload);
        createSnapshot(doc, reason);
      };
      card.querySelector('#saveBtn').onclick = () => {
        const payload = collectDocFields(card, doc, doc.status || 'draft');
        const isNew = !state.docs.find(d => d.id === payload.id);
        payload.version = (payload.version || 0) + 1;
        assignAndPersist(payload, 'guardar');
        logEvent(isNew ? 'doc_created' : 'doc_edited', { docId: payload.id, version: payload.version, mode: 'manual' });
        toast('Versi√≥n guardada');
        location.hash = `#/doc/${payload.id}`;
      };
      card.querySelector('#reviewBtn').onclick = () => {
        if (!['editor','admin'].includes(state.currentUser.role)) { toast('Solo editores pueden enviar a revisi√≥n'); return; }
        const payload = collectDocFields(card, doc, 'in_review');
        const isNew = !state.docs.find(d => d.id === payload.id);
        payload.version = (payload.version || 0) + 1;
        assignAndPersist(payload, 'env√≠o a revisi√≥n');
        logEvent(isNew ? 'doc_created' : 'doc_edited', { docId: payload.id, version: payload.version, mode: 'review' });
        logEvent('workflow_submitted', { docId: payload.id });
        toast('Enviado a revisi√≥n');
        location.hash = `#/doc/${payload.id}`;
      };
      card.querySelector('#publishBtn').onclick = () => {
        if (!['admin','manager'].includes(state.currentUser.role)) { toast('Solo admin/manager aprueban'); return; }
        if (doc.status !== 'in_review' && doc.status !== 'published') { toast('Debe estar en revisi√≥n para aprobar'); return; }
        const payload = collectDocFields(card, doc, 'published');
        payload.version = (payload.version || 0) + 1;
        assignAndPersist(payload, 'publicaci√≥n');
        logEvent('workflow_approved', { docId: payload.id });
        logEvent('doc_published', { docId: payload.id, version: payload.version });
        toast('Publicado');
        location.hash = `#/doc/${payload.id}`;
      };
      const autoSave = () => {
        const payload = collectDocFields(card, doc, doc.status);
        const exists = state.docs.some(d => d.id === payload.id);
        doc = upsertDoc(payload);
        logEvent(exists ? 'doc_edited' : 'doc_created', { docId: payload.id, mode: 'autosave' });
      };
      if (editorAutoSave) clearInterval(editorAutoSave);
      editorAutoSave = setInterval(autoSave, autoSaveMs);
      container.appendChild(card);
      return container;
    }

    function collectDocFields(card, base, statusOverride) {
      const title = card.querySelector('#title').value.trim() || 'Sin t√≠tulo';
      const type = card.querySelector('#type').value;
      const space = card.querySelector('#space').value;
      const tags = card.querySelector('#tags').value.split(',').map(t => t.trim()).filter(Boolean);
      const content = card.querySelector('#content').value;
      return { ...base, title, type, space, tags, content, status: statusOverride || base.status, updatedAt: Date.now(), version: base.version ?? 0 };
    }

    function upsertDoc(doc) {
      const idx = state.docs.findIndex(d => d.id === doc.id);
      if (idx >= 0) {
        state.docs[idx] = doc;
      } else {
        state.docs.push(doc);
      }
      persist();
      return doc;
    }

    function createSnapshot(doc, reason) {
      state.versions.push({
        id: crypto.randomUUID(),
        docId: doc.id,
        version: doc.version || 1,
        snapshotAt: Date.now(),
        status: doc.status,
        title: doc.title,
        content: doc.content,
        tags: doc.tags,
        type: doc.type,
        space: doc.space,
        reason
      });
      persist();
    }

    function renderAnalytics() {
      if (!['admin','manager'].includes(state.currentUser.role)) {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = '<h2>No autorizado</h2>';
        return card;
      }
      const card = document.createElement('div');
      card.className = 'card';
      const zeroResults = state.events.filter(e => e.type === 'zero_results' || e.type === 'search_zero_results').length;
      const searches = state.events.filter(e => e.type === 'search_performed').length;
      const views = state.events.filter(e => e.type === 'doc_viewed').length;
      const created = state.events.filter(e => e.type === 'doc_created').length;
      const published = state.events.filter(e => e.type === 'doc_published').length;
      const inReview = state.docs.filter(d => d.status === 'in_review').length;
      const expiring = state.docs.filter(d => Date.now() - d.updatedAt > 20*86400000).length;
      card.innerHTML = `
        <div class="flex space-between"><h2>Anal√≠tica</h2><span class="small">Overview ¬∑ Search gaps ¬∑ Content health</span></div>
        <div class="grid three" style="margin-top:10px;">
          ${metricTile('B√∫squedas', searches)}
          ${metricTile('Zero results', zeroResults, zeroResults>0 ? 'warning' : '')}
          ${metricTile('Gaps reportados', state.gaps.length, state.gaps.length>0 ? 'warning' : '')}
          ${metricTile('Vistas', views)}
          ${metricTile('Creados', created)}
          ${metricTile('Publicados', published)}
          ${metricTile('En revisi√≥n', inReview)}
        </div>
        <h3 style="margin-top:14px;">Search gaps</h3>
        <p class="small">Consultas sin resultados. Genera art√≠culos desde aqu√≠.</p>
        <div class="grid two" id="gaps"></div>
        <h3 style="margin-top:14px;">Content health</h3>
        <p class="small">Documentos antiguos o sin publicar.</p>
        <div class="grid two" id="health"></div>`;
      const gaps = card.querySelector('#gaps');
      const gapEntries = state.gaps.slice(-5);
      if (gapEntries.length === 0) gaps.innerHTML = '<p class="small">Sin brechas por ahora.</p>';
      gapEntries.forEach(ev => {
        const box = document.createElement('div');
        box.className = 'card';
        box.innerHTML = `
          <div class="flex space-between"><strong>${ev.q || 'Consulta desconocida'}</strong><span class="small">${new Date(ev.createdAt || ev.at).toLocaleString()}</span></div>
          <p class="small">Etiquetas: ${(ev.filters?.tags || []).join(', ') || 'n/d'} ¬∑ Espacio: ${ev.filters?.space || 'todos'}</p>
          <button class="btn primary" onclick="location.hash='#/edit/new'">Crear desde gap</button>`;
        gaps.appendChild(box);
      });
      const health = card.querySelector('#health');
      const stale = state.docs.filter(d => Date.now() - d.updatedAt > 20*86400000);
      const drafts = state.docs.filter(d => d.status === 'draft');
      if (stale.length === 0 && drafts.length === 0) {
        health.innerHTML = '<p class="small">Contenido sano.</p>';
      } else {
        const staleCard = document.createElement('div');
        staleCard.className = 'card';
        staleCard.innerHTML = `<h4>Por revisar</h4>${stale.map(d => `<div>${d.title}</div>`).join('') || '<p class="small">N/A</p>'}`;
        const draftCard = document.createElement('div');
        draftCard.className = 'card';
        draftCard.innerHTML = `<h4>Drafts</h4>${drafts.map(d => `<div>${d.title}</div>`).join('') || '<p class="small">N/A</p>'}`;
        health.append(staleCard, draftCard);
      }
      return card;
    }

    function metricTile(label, value, tone) {
      const color = tone === 'warning' ? 'var(--warning)' : 'var(--accent-2)';
      return `<div class="card" style="border-color:${color};"><h3>${label}</h3><div style="font-size:28px; font-weight:800;">${value}</div></div>`;
    }

    window.addEventListener('hashchange', render);
    render();
  </script>
</body>
</html>
