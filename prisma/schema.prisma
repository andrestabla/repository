generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Methodology {
  id        String   @id @default(cuid())
  version   String   @unique
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ContentItem {
  id               String              @id
  title            String
  type             String
  version          String
  status           String
  ip               String?
  completeness     Int                 @default(0)
  driveId          String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  level            String?
  sub              String?
  authorizedUse    String?
  behavior         String?
  challengeType    String?
  competence       String?
  confidentiality  String?
  duration         String?
  evidenceRequired String?
  fileUrl          String?
  format           String?
  impactScore      Boolean?
  industry         String?
  intervention     String?
  ipOwner          String?
  ipType           String?
  language         String?
  maturity         String?
  moment           String?
  nextContentId    String?
  observations     String?
  outcomeType      String?
  prereqId         String?
  publicVisibility Boolean?
  recommendation   String?
  reuseExternal    Boolean?
  roleLevel        String?
  source           String?
  targetRole       String?
  testId           String?
  trigger          String?
  uploadedAt       DateTime?
  variable         String?
  vipUsage         Boolean?
  year             String?
  releaseId        String?
  primaryPillar    String              @default("Transversal")
  secondaryPillars String[]            @default([])
  transcription    String?
  metadata         Json?
  geminiName       String?
  geminiUri        String?
  release          MethodologyRelease? @relation(fields: [releaseId], references: [id])
  researchSources  ResearchSource[]    @relation("ContentReferences")

  @@index([releaseId])
}

model ResearchSource {
  id                 String        @id @default(cuid())
  title              String
  apa                String?
  url                String?
  summary            String?
  keyConcepts        String?
  findings           String?
  methodology        String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  relation4Shine     String?
  driveId            String?
  pillars            String[]      @default([])
  transcription      String?
  competence         String?
  geographicCoverage String?
  populationParams   String?
  referencedBy       ContentItem[] @relation("ContentReferences")
}

model MethodologyRelease {
  id          String        @id @default(cuid())
  tag         String        @unique
  description String?
  status      String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  contents    ContentItem[]
}

model Taxonomy {
  id       String     @id @default(cuid())
  name     String
  type     String
  parentId String?
  active   Boolean    @default(true)
  order    Int        @default(0)
  parent   Taxonomy?  @relation("TaxonomyHierarchy", fields: [parentId], references: [id])
  children Taxonomy[] @relation("TaxonomyHierarchy")
}

model User {
  email     String      @id
  name      String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  isActive  Boolean     @default(true)
  role      Role        @default(CURADOR)
  logs      SystemLog[]
}

model SystemLog {
  id         Int      @id @default(autoincrement())
  action     String
  details    String?
  resourceId String?
  userEmail  String
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userEmail], references: [email])
}

model Artifact {
  id      String   @id @default(cuid())
  name    String
  type    String
  lastGen DateTime @updatedAt
  link    String?
}

model SystemSettings {
  key       String   @id
  value     Json
  updatedAt DateTime @updatedAt
}

model GenerationHistory {
  id        String   @id @default(cuid())
  user      String?
  prompt    String
  response  String
  type      String
  assets    String[]
  createdAt DateTime @default(now())
  research  String[] @default([])
}

model GlossaryTerm {
  id         String   @id @default(cuid())
  term       String   @unique
  definition String
  pillars    String[] @default([])
  source     String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

enum Role {
  METODOLOGO
  CURADOR
  AUDITOR
  ADMIN
}

model StrategicProduct {
  id          String   @id @default(cuid())
  title       String
  description String?  // @db.Text not supported in basic postgres prisma unless using specific provider features, but String in Prisma maps to text in Postgres usually or we can rely on default
  type        String   // PDF, Presentation, Video, Spreadsheet, Doc
  driveLink   String   // URL de Google Drive o externa
  embedCode   String?  // Código HTML para embedders (YouTube, Vimeo, etc.)
  driveId     String?  // ID extraído para embed
  category    String?  // Categoría personalizada o tag
  tags        String[] @default([])
  
  // Metadatos de IA
  aiSummary   String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relaciones opcionales
  pillar      String? 
  comments    StrategicProductComment[]
}

model StrategicProductComment {
  id        String           @id @default(cuid())
  content   String           @db.Text
  productId String
  product   StrategicProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  userEmail String
  userName  String?
  createdAt DateTime         @default(now())
}
