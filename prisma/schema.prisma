generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Methodology {
  id        String   @id @default(cuid())
  version   String   @unique
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ContentItem {
  id               String              @id
  title            String
  type             String
  primaryPillar    String              @default("Transversal")
  secondaryPillars String[]            @default([])
  version          String
  status           String
  ip               String?
  completeness     Int                 @default(0)
  driveId          String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  level            String?
  sub              String?
  authorizedUse    String?
  behavior         String?
  challengeType    String?
  competence       String?
  confidentiality  String?
  duration         String?
  evidenceRequired String?
  fileUrl          String?
  format           String?
  impactScore      Boolean?
  industry         String?
  intervention     String?
  ipOwner          String?
  ipType           String?
  language         String?
  maturity         String?
  moment           String?
  nextContentId    String?
  observations     String?
  outcomeType      String?
  transcription    String? // New field for video/audio transcripts
  prereqId         String?
  publicVisibility Boolean?
  recommendation   String?
  reuseExternal    Boolean?
  roleLevel        String?
  source           String?
  targetRole       String?
  testId           String?
  trigger          String?
  uploadedAt       DateTime?
  variable         String?
  vipUsage         Boolean?
  year             String?
  releaseId        String?
  release          MethodologyRelease? @relation(fields: [releaseId], references: [id])

  @@index([releaseId])
}

model MethodologyRelease {
  id          String        @id @default(cuid())
  tag         String        @unique
  description String?
  status      String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  contents    ContentItem[]
}

model Taxonomy {
  id       String     @id @default(cuid())
  name     String
  type     String
  parentId String?
  active   Boolean    @default(true)
  order    Int        @default(0)
  parent   Taxonomy?  @relation("TaxonomyHierarchy", fields: [parentId], references: [id])
  children Taxonomy[] @relation("TaxonomyHierarchy")
}

enum Role {
  METODOLOGO
  CURADOR
  AUDITOR
  ADMIN
}

model User {
  email     String   @id
  name      String?
  role      Role     @default(CURADOR)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  logs      SystemLog[]
}

model SystemLog {
  id         Int      @id @default(autoincrement())
  action     String   // 'LOGIN', 'APPROVE', 'FORCE_UNLOCK', 'DELETE_NODE'
  details    String?  // JSON o texto: "Cambió título de X a Y"
  resourceId String?  // ID del contenido afectado (opcional)
  
  userEmail  String
  user       User     @relation(fields: [userEmail], references: [email])
  
  createdAt  DateTime @default(now())
}

model Artifact {
  id      String   @id @default(cuid())
  name    String
  type    String
  lastGen DateTime @updatedAt
  link    String?
}

model SystemSettings {
  key       String   @id
  value     Json
  updatedAt DateTime @updatedAt
}

model GenerationHistory {
  id        String   @id @default(cuid())
  user      String?
  prompt    String
  response  String   @db.Text
  type      String
  assets    String[]
  createdAt DateTime @default(now())
}
