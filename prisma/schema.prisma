generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Methodology {
  id        String   @id @default(cuid())
  version   String   @unique
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ContentItem {
  id               String              @id
  title            String
  type             String
  version          String
  status           String
  ip               String?
  completeness     Int                 @default(0)
  driveId          String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  level            String?
  sub              String?
  authorizedUse    String?
  behavior         String?
  challengeType    String?
  competence       String?
  confidentiality  String?
  duration         String?
  evidenceRequired String?
  fileUrl          String?
  format           String?
  impactScore      Boolean?
  industry         String?
  intervention     String?
  ipOwner          String?
  ipType           String?
  language         String?
  maturity         String?
  moment           String?
  nextContentId    String?
  observations     String?
  outcomeType      String?
  prereqId         String?
  publicVisibility Boolean?
  recommendation   String?
  reuseExternal    Boolean?
  roleLevel        String?
  source           String?
  targetRole       String?
  testId           String?
  trigger          String?
  uploadedAt       DateTime?
  variable         String?
  vipUsage         Boolean?
  year             String?
  releaseId        String?
  primaryPillar    String              @default("Transversal")
  secondaryPillars String[]            @default([])
  transcription    String?
  metadata         Json?
  geminiName       String?
  geminiUri        String?
  release          MethodologyRelease? @relation(fields: [releaseId], references: [id])
  researchSources  ResearchSource[]    @relation("ContentReferences")

  @@index([releaseId])
}

model ResearchSource {
  id                 String        @id @default(cuid())
  title              String
  apa                String?
  url                String?
  summary            String?
  keyConcepts        String?
  findings           String?
  methodology        String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  relation4Shine     String?
  driveId            String?
  pillars            String[]      @default([])
  transcription      String?
  competence         String?
  geographicCoverage String?
  populationParams   String?
  referencedBy       ContentItem[] @relation("ContentReferences")
}

model MethodologyRelease {
  id          String        @id @default(cuid())
  tag         String        @unique
  description String?
  status      String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  contents    ContentItem[]
}

model Taxonomy {
  id       String     @id @default(cuid())
  name     String
  type     String
  parentId String?
  active   Boolean    @default(true)
  order    Int        @default(0)
  parent   Taxonomy?  @relation("TaxonomyHierarchy", fields: [parentId], references: [id])
  children Taxonomy[] @relation("TaxonomyHierarchy")
}

model User {
  email          String      @id
  name           String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  isActive       Boolean     @default(true)
  role           Role        @default(CURADOR)
  allowedModules String[]    @default([])
  logs           SystemLog[]
}

model SystemLog {
  id         Int      @id @default(autoincrement())
  action     String
  details    String?
  resourceId String?
  userEmail  String
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userEmail], references: [email])
}

model Artifact {
  id      String   @id @default(cuid())
  name    String
  type    String
  lastGen DateTime @updatedAt
  link    String?
}

model SystemSettings {
  key       String   @id
  value     Json
  updatedAt DateTime @updatedAt
}

model GenerationHistory {
  id        String   @id @default(cuid())
  user      String?
  prompt    String
  response  String
  type      String
  assets    String[]
  createdAt DateTime @default(now())
  research  String[] @default([])
}

model GlossaryTerm {
  id         String   @id @default(cuid())
  term       String   @unique
  definition String
  pillars    String[] @default([])
  source     String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model StrategicProduct {
  id          String                    @id @default(cuid())
  title       String
  description String?
  type        String
  driveLink   String?
  driveId     String?
  category    String?
  tags        String[]                  @default([])
  aiSummary   String?
  createdAt   DateTime                  @default(now())
  updatedAt   DateTime                  @updatedAt
  pillar      String?
  embedCode   String?
  comments    StrategicProductComment[]
  versions    StrategicProductVersion[]
}

model StrategicProductVersion {
  id            String           @id @default(cuid())
  versionNumber Int
  driveLink     String?
  driveId       String?
  embedCode     String?
  notes         String?
  productId     String
  createdAt     DateTime         @default(now())
  product       StrategicProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model StrategicProductComment {
  id        String           @id @default(cuid())
  content   String
  productId String
  userEmail String
  userName  String?
  createdAt DateTime         @default(now())
  product   StrategicProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Workbook {
  id          String   @id @default(cuid())
  title       String
  description String?
  metadata    Json?
  status      String   @default("Borrador")
  driveId     String?
  content     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  type        String?
  slug        String?  @unique
}

enum Role {
  METODOLOGO
  CURADOR
  AUDITOR
  ADMIN
}
